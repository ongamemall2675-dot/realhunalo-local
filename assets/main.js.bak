// ================================================================
// RealHunalo Studio - Unified Office Application
// ================================================================

// --- âš™ï¸ CONFIGURATION ---
const CONFIG = {
    // ì—¬ê¸°ì— n8n ì‹¤ì œ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš” (server.py ëŒ€ì‹  ì§ì ‘ í˜¸ì¶œ)
    endpoints: {
        // [Production URL] n8n ì›Œí¬í”Œë¡œìš°ê°€ 'Activated' ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
        script: "https://n8n.hyehwa72.org/webhook/script-scenes/process",

        image: "https://n8n.hyehwa72.org/webhook/process-image",
        motion: "https://n8n.hyehwa72.org/webhook/process-motion",
        tts: "https://n8n.hyehwa72.org/webhook/process-tts",
        video: "https://n8n.hyehwa72.org/webhook/process-video"
    }
};

// --- ğŸ—ï¸ SYSTEM ARCHITECTURE ---

// 1. Module Base Class
class Module {
    constructor(id, name, icon, desc) {
        this.id = id;
        this.name = name;
        this.icon = icon;
        this.desc = desc;
    }
    render() { return `<div class="text-center p-20">ëª¨ë“ˆ ì¤€ë¹„ ì¤‘...</div>`; }
    onMount() { } // Called after render
}

// 1.5 Global State Management
const AppState = {
    currentModule: 'script',
    scenes: [],
    script: '',
    style: '2D infographic',
    ratio: '16:9',
    resolution: '2K',

    setScenes(scenes) {
        this.scenes = scenes;
        window.dispatchEvent(new CustomEvent('app-state-changed'));
    },
    getScenes() { return this.scenes; },

    setScript(text) { this.script = text; },
    getScript() { return this.script; },

    setStyle(style) { this.style = style; },
    setRatio(ratio) { this.ratio = ratio; },
    setResolution(res) { this.resolution = res; }
};

// --- ğŸ› ï¸ UTILS ---
async function processInBatches(items, batchSize, asyncFn, onProgress) {
    const results = [];
    let completed = 0;

    // Split into chunks
    for (let i = 0; i < items.length; i += batchSize) {
        const chunk = items.slice(i, i + batchSize);
        // Process chunk in parallel
        const chunkResults = await Promise.all(chunk.map(async (item) => {
            try {
                return await asyncFn(item);
            } catch (e) {
                console.error("Batch processing error:", e);
                return null;
            } finally {
                completed++;
                if (onProgress) onProgress(completed, items.length);
            }
        }));
        results.push(...chunkResults);

        // Optional delay between batches
        if (i + batchSize < items.length) await new Promise(r => setTimeout(r, 500));
    }
    return results;
}

// --- ğŸ¯ GLOBAL DRAG & DROP HANDLERS ---
// VideoModuleì—ì„œ ì‚¬ìš©í•˜ëŠ” ë“œë˜ê·¸ì•¤ë“œë ë° íŒŒì¼ ì„ íƒ í•¸ë“¤ëŸ¬

window.handleVideoAssetDrop = function (event, dropZone) {
    event.preventDefault();
    dropZone.classList.remove('border-purple-500', 'bg-purple-500/10');

    const sceneId = dropZone.getAttribute('data-scene-id');
    const files = event.dataTransfer.files;

    if (files.length > 0) {
        const file = files[0];
        processDroppedFile(file, sceneId, dropZone);
    }
};

window.handleVideoFileSelect = function (event, sceneId) {
    const file = event.target.files[0];
    if (file) {
        const dropZone = document.querySelector(`.drop-zone-video[data-scene-id="${sceneId}"]`);
        processDroppedFile(file, sceneId, dropZone);
    }
};

function processDroppedFile(file, sceneId, dropZone) {
    const scene = AppState.getScenes().find(s => s.sceneId == sceneId);
    if (!scene) return;

    const reader = new FileReader();
    reader.onload = function (e) {
        const dataUrl = e.target.result;

        if (file.type.startsWith('video/')) {
            // ë¹„ë””ì˜¤ íŒŒì¼
            scene.videoUrl = dataUrl;
            dropZone.innerHTML = `<video src="${dataUrl}" controls class="w-full h-full object-cover"></video>`;
        } else if (file.type.startsWith('image/')) {
            // ì´ë¯¸ì§€ íŒŒì¼
            scene.generatedUrl = dataUrl;
            dropZone.innerHTML = `<img src="${dataUrl}" class="w-full h-full object-cover">`;
        }

        console.log(`Scene ${sceneId}: ë¯¸ë””ì–´ êµì²´ë¨ (${file.name})`);
        alert(`Scene ${sceneId}ì˜ ë¯¸ë””ì–´ê°€ êµì²´ë˜ì—ˆìŠµë‹ˆë‹¤.`);
    };
    reader.readAsDataURL(file);
}

// --- ğŸ¬ VIDEO LIGHTBOX ---
window.openVideoLightbox = function (src) {
    // ê¸°ì¡´ lightboxê°€ ìˆë‹¤ë©´ ì œê±°
    const existing = document.getElementById('video-lightbox-overlay');
    if (existing) existing.remove();

    const overlay = document.createElement('div');
    overlay.id = 'video-lightbox-overlay';
    overlay.className = 'fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-8';
    overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };

    overlay.innerHTML = `
        <div class="relative max-w-4xl w-full">
            <video src="${src}" controls autoplay class="w-full rounded-2xl shadow-2xl" style="max-height: 80vh;"></video>
            <button onclick="this.closest('#video-lightbox-overlay').remove()" 
                class="absolute -top-4 -right-4 p-2 bg-red-500 hover:bg-red-400 text-white rounded-full shadow-lg transition">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    `;

    document.body.appendChild(overlay);
};

// 2. Trend Module (íŠ¸ë Œë“œ ë¶„ì„)
class TrendModule extends Module {
    constructor() { super('trend', 'íŠ¸ë Œë“œ ë¶„ì„ì‹¤', 'trending-up', 'ë„¤ì´ë²„/êµ¬ê¸€ ì‹¤ì‹œê°„ íŠ¸ë Œë“œë¥¼ ë¶„ì„í•©ë‹ˆë‹¤.'); }
    render() {
        return `
            <div class="max-w-4xl mx-auto space-y-8 slide-up">
                <div class="grid grid-cols-2 gap-6">
                    <div class="bg-slate-800/40 border border-slate-700 p-6 rounded-2xl hover:border-green-500/50 transition duration-300">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-lg bg-green-500/10 flex items-center justify-center text-green-500"><i data-lucide="search"></i></div>
                            <h3 class="font-bold text-lg text-white">Naver Trend API</h3>
                        </div>
                        <p class="text-sm text-slate-400 mb-6">ë„¤ì´ë²„ ê²€ìƒ‰ì–´ ìˆœìœ„ ë° ì—°ê´€ ê²€ìƒ‰ì–´ ì¶”ì¶œ</p>
                        <button class="w-full py-3 bg-slate-700 hover:bg-green-600 hover:text-white rounded-xl text-sm font-bold transition">ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘</button>
                    </div>
                    <div class="bg-slate-800/40 border border-slate-700 p-6 rounded-2xl hover:border-red-500/50 transition duration-300">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-lg bg-red-500/10 flex items-center justify-center text-red-500"><i data-lucide="globe"></i></div>
                            <h3 class="font-bold text-lg text-white">Google Trends</h3>
                        </div>
                        <p class="text-sm text-slate-400 mb-6">ê¸€ë¡œë²Œ ë° ì§€ì—­ë³„ ê´€ì‹¬ë„ ë³€í™” ì¶”ì </p>
                        <button class="w-full py-3 bg-slate-700 hover:bg-red-600 hover:text-white rounded-xl text-sm font-bold transition">ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘</button>
                    </div>
                </div>
            </div>
        `;
    }
}

// 3. Youtube Module (ìœ íŠœë¸Œ ì†Œì¬)
class YoutubeModule extends Module {
    constructor() { super('youtube', 'ìœ íŠœë¸Œ ì†Œì¬ì‹¤', 'youtube', 'ìœ íŠœë¸Œ API ê¸°ë°˜ ì¸ê¸° ì†Œì¬ ë°œêµ´'); }
    render() {
        return `
            <div class="max-w-4xl mx-auto slide-up">
                 <div class="bg-slate-800/40 border border-slate-700 p-8 rounded-3xl">
                    <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-2"><i data-lucide="youtube" class="text-red-500"></i> í‚¤ì›Œë“œ íƒìƒ‰</h3>
                    <div class="flex gap-4">
                        <input type="text" placeholder="ê²€ìƒ‰í•  í‚¤ì›Œë“œ (ì˜ˆ: ê²½ì œ ì „ë§)" class="flex-1 bg-slate-900 border border-slate-700 rounded-xl px-5 py-4 text-white focus:border-red-500 outline-none transition">
                        <button class="px-8 bg-slate-700 hover:bg-red-600 text-white font-bold rounded-xl transition">ê²€ìƒ‰</button>
                    </div>
                 </div>
            </div>
        `;
    }
}

// 4. Script Module (ëŒ€ë³¸ ë¶„í•  - í•µì‹¬)
class ScriptModule extends Module {
    constructor() { super('script', 'ëŒ€ë³¸ ë¶„ì„ì‹¤', 'file-text', 'GPT-Mini ê¸°ë°˜ ëŒ€ë³¸ ì´ˆì •ë°€ ì„¸ë¶„í™”'); }

    render() {
        return `
            <div class="h-full flex flex-col lg:flex-row gap-8 slide-up">
                <!-- Input Section -->
                <div class="flex-1 bg-slate-800/40 border border-slate-700 rounded-3xl p-1 flex flex-col">
                    <div class="bg-slate-800/20 border border-slate-700/50 rounded-3xl p-8 mb-8 shadow-inner">
                    <label class="block text-xs font-black text-slate-500 uppercase tracking-widest mb-4">ëŒ€ë³¸ ë³¸ë¬¸</label>
                    <textarea id="script-input" 
                        class="w-full h-80 bg-transparent text-slate-200 text-lg leading-relaxed placeholder-slate-600 focus:outline-none resize-none scrollbar-hide"
                        placeholder="ì—¬ê¸°ì— ëŒ€ë³¸ì„ ì…ë ¥í•˜ì„¸ìš”...">${AppState.getScript()}</textarea>
                </div>
                    <div class="p-4 border-t border-slate-700 flex justify-between items-center bg-slate-900/50 rounded-b-3xl">
                        <span class="text-xs font-bold text-slate-500 uppercase tracking-widest pl-4">Script Input</span>
                        <button id="btn-analyze" class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-blue-600/20 transition flex items-center gap-2">
                            <i data-lucide="sparkles" class="w-4 h-4"></i> ë¶„ì„ ì‹œì‘
                        </button>
                    </div>
                </div>

                <!-- Options Section -->
                <div class="w-80 space-y-6">
                    <div class="bg-slate-800/40 border border-slate-700 p-6 rounded-2xl">
                        <h4 class="text-sm font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="sliders" class="w-4 h-4 text-blue-400"></i> ë¶„ì„ ì˜µì…˜</h4>
                        
                        <div class="space-y-4">
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-2">í™”í’ ìŠ¤íƒ€ì¼</label>
                                <select id="opt-style" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-sm text-slate-300 outline-none focus:border-blue-500">
                                    <option value="stickman">ìŠ¤í‹±ë§¨ (ì¸í¬ê·¸ë˜í”½)</option>
                                    <option value="realistic">ì‹¤ì‚¬ (Cinematic)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-2">í™”ë©´ ë¹„ìœ¨</label>
                                <div class="grid grid-cols-3 gap-2">
                                    <button class="opt-ratio active py-2 bg-slate-900 border border-blue-500 text-blue-400 rounded-lg text-xs font-bold transition">16:9</button>
                                    <button class="opt-ratio py-2 bg-slate-900 border border-slate-700 text-slate-400 rounded-lg text-xs font-bold hover:border-slate-500 transition">9:16</button>
                                    <button class="opt-ratio py-2 bg-slate-900 border border-slate-700 text-slate-400 rounded-lg text-xs font-bold hover:border-slate-500 transition">1:1</button>
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-500 mb-2">í•´ìƒë„</label>
                                <select class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-sm text-slate-300 outline-none focus:border-blue-500">
                                    <option>1K (Fast)</option>
                                    <option>2K (Balanced)</option>
                                    <option>4K (High)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-6 rounded-2xl bg-blue-500/10 border border-blue-500/20">
                        <p class="text-xs text-blue-300 leading-relaxed font-medium">
                            ğŸ’¡ <b>Tip:</b> GPT-Miniê°€ ì¥ë©´ì„ ìë™ìœ¼ë¡œ êµ¬ë¶„í•˜ê³  ìµœì ì˜ í”„ë¡¬í”„íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
                        </p>
                    </div>
                </div>
            </div>
        `;
    }

    onMount() {
        const btn = document.getElementById('btn-analyze');
        const textarea = document.getElementById('script-input');

        // Sync textarea to AppState
        textarea.addEventListener('input', (e) => {
            AppState.setScript(e.target.value);
        });

        btn.addEventListener('click', async () => {
            const text = textarea.value.trim();
            if (!text) return alert("ëŒ€ë³¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");

            // Save state before starting
            const style = document.getElementById('opt-style').value;
            const ratioBtn = document.querySelector('.opt-ratio.active') || document.querySelector('.opt-ratio');
            const ratio = ratioBtn ? ratioBtn.innerText : '16:9';
            const resolution = document.querySelector('select:not(#opt-style)').value || '2K';

            AppState.setScript(text);
            AppState.setStyle(style);
            AppState.setRatio(ratio);
            AppState.setResolution(resolution);

            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> ë¶„ì„ ì¤‘...`;

            try {
                console.log("Starting Fetch to:", CONFIG.endpoints.script);

                // Call Direct n8n URL
                const response = await fetch(CONFIG.endpoints.script, {
                    method: 'POST',
                    mode: 'cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        script: text,
                        style: AppState.style,
                        aspect_ratio: AppState.ratio,
                        resolution: AppState.resolution
                    })
                });

                if (!response.ok) throw new Error(`ì„œë²„ í†µì‹  ì‹¤íŒ¨: ${response.status}`);

                const rawText = await response.text();
                console.log("Raw Server Response:", rawText);

                if (!rawText) {
                    throw new Error("ì„œë²„ë¡œë¶€í„° ë¹ˆ ì‘ë‹µì´ ì™”ìŠµë‹ˆë‹¤. n8n ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ë‚´ì—­ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.");
                }

                let result;
                try {
                    result = JSON.parse(rawText);
                } catch (e) {
                    throw new Error("JSON íŒŒì‹± ì‹¤íŒ¨. ì‘ë‹µ ë‚´ìš©: " + rawText);
                }

                console.log("ë¶„ì„ ê²°ê³¼:", result);

                if (result.scenes && Array.isArray(result.scenes)) {
                    AppState.setScenes(result.scenes);
                    alert(`ë¶„ì„ ì™„ë£Œ! ${result.scenes.length}ê°œì˜ ì¥ë©´ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    app.route('image');
                } else {
                    throw new Error("ë¶„ì„ ê²°ê³¼ì— ì¥ë©´(scenes) ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.");
                }
            } catch (e) {
                console.error("Fetch Error Detail:", e);
                alert("ì—ëŸ¬ ë°œìƒ: " + e.message + "\n\n(ì°¸ê³ : n8nì˜ 'Test Workflow'ê°€ í™œì„±í™”ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ê±°ë‚˜, Production URL ì‚¬ìš©ì„ ê²€í† í•˜ì„¸ìš”.)");
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<i data-lucide="sparkles" class="w-4 h-4"></i> ë¶„ì„ ì‹œì‘`;
                lucide.createIcons();
            }
        });

        // Simple ratio selector logic
        const ratios = document.querySelectorAll('.opt-ratio');
        ratios.forEach(r => r.addEventListener('click', () => {
            ratios.forEach(b => {
                b.classList.remove('active', 'border-blue-500', 'text-blue-400');
                b.classList.add('border-slate-700', 'text-slate-400');
            });
            r.classList.remove('border-slate-700', 'text-slate-400');
            r.classList.add('active', 'border-blue-500', 'text-blue-400');
        }));
    }
}

// 5. Image Module
class ImageModule extends Module {
    constructor() { super('image', 'ë¯¸ìˆ  ì‘ì—…ì‹¤', 'palette', 'ë¶„ì„ëœ ì¥ë©´ì„ ì‹œê°í™”í•©ë‹ˆë‹¤.'); }

    render() {
        const scenes = AppState.getScenes();

        // ë…ë¦½ ì‹¤í–‰ ëª¨ë“œ íŒ¨ë„
        const standalonePanel = `
            <div class="bg-gradient-to-r from-green-900/30 to-blue-900/30 border border-green-500/30 rounded-2xl p-6 mb-6">
                <div class="flex items-center gap-3 mb-4">
                    <div class="p-2 bg-green-500/20 rounded-lg text-green-400">
                        <i data-lucide="plus-square" class="w-5 h-5"></i>
                    </div>
                    <h3 class="text-lg font-bold text-white">â• ì¥ë©´ ìˆ˜ë™ ì¶”ê°€</h3>
                    <span class="ml-auto text-xs text-green-400 bg-green-500/20 px-3 py-1 rounded-full">ë¶„ì„ ì—†ì´ ì§ì ‘ ì¶”ê°€</span>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-wider block mb-2">ëŒ€ë³¸</label>
                        <textarea id="manual-scene-script" 
                            class="w-full h-20 bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm text-slate-200 focus:ring-2 focus:ring-green-500 focus:border-transparent transition resize-none scrollbar-hide"
                            placeholder="ì¥ë©´ì˜ ëŒ€ë³¸ì„ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-wider block mb-2">ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ (ì„ íƒ)</label>
                        <textarea id="manual-scene-prompt" 
                            class="w-full h-20 bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm text-slate-200 focus:ring-2 focus:ring-green-500 focus:border-transparent transition resize-none scrollbar-hide"
                            placeholder="ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”... (ë¹„ìš°ë©´ ìë™ ìƒì„±)"></textarea>
                    </div>
                </div>
                
                <button id="btn-add-manual-scene" class="mt-4 w-full bg-green-600 hover:bg-green-500 text-white px-4 py-3 rounded-xl text-sm font-bold shadow-lg shadow-green-600/20 transition flex items-center justify-center gap-2">
                    <i data-lucide="plus-circle" class="w-4 h-4"></i> ì¥ë©´ ì¶”ê°€
                </button>
            </div>
        `;

        if (scenes.length === 0) {
            return `
                <div class="max-w-4xl mx-auto slide-up space-y-6">
                    ${standalonePanel}
                    
                    <div class="text-center p-10 text-slate-500 border border-dashed border-slate-700 rounded-2xl">
                        <i data-lucide="image" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
                        <h3 class="text-lg font-bold">ì¥ë©´ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                        <p class="text-sm mt-2">ìœ„ì—ì„œ ì¥ë©´ì„ ìˆ˜ë™ìœ¼ë¡œ ì¶”ê°€í•˜ê±°ë‚˜, ëŒ€ë³¸ ë¶„ì„ì‹¤ì—ì„œ ë¶„ì„ì„ ì§„í–‰í•˜ì„¸ìš”.</p>
                    </div>
                </div>
            `;
        }

        const sceneRows = scenes.map(scene => `
            <tr class="border-b border-slate-800/30 hover:bg-white/5 transition group" id="row-${scene.sceneId}">
                <td class="py-4 pl-6 text-xs font-bold text-slate-500 w-16">#${scene.sceneId}</td>
                <td class="py-4 px-4 w-1/4">
                    <textarea class="scene-script-edit w-full bg-slate-900/50 border border-slate-700 rounded-lg p-2 text-sm text-slate-300 resize-none h-16 scrollbar-hide focus:ring-1 focus:ring-blue-500" 
                        data-scene-id="${scene.sceneId}">${scene.originalScript}</textarea>
                </td>
                <td class="py-4 px-4 w-1/3">
                    <textarea class="scene-prompt-edit w-full bg-slate-900/50 border border-slate-700 rounded-lg p-2 text-[11px] text-slate-400 font-mono italic resize-none h-16 scrollbar-hide focus:ring-1 focus:ring-blue-500" 
                        data-scene-id="${scene.sceneId}"
                        placeholder="ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸ (í¸ì§‘ ê°€ëŠ¥)">${scene.imagePrompt || ''}</textarea>
                </td>
                <td class="py-4 px-4">
                    <div class="w-40 aspect-video bg-slate-900/50 rounded-lg border border-slate-700/50 flex items-center justify-center overflow-hidden relative group drop-zone" 
                         data-scene-id="${scene.sceneId}" 
                         data-drop-type="image"
                         ondragover="event.preventDefault(); this.classList.add('border-blue-500', 'bg-blue-500/10');" 
                         ondragleave="this.classList.remove('border-blue-500', 'bg-blue-500/10');" 
                         ondrop="window.handleAssetDrop(event, this)">
                        <div class="image-placeholder text-[8px] text-slate-600 font-bold uppercase tracking-widest text-center px-2">No Image<br><span class="text-[7px] opacity-60">Drag to Replace</span></div>
                        <img src="${scene.generatedUrl || ''}" class="${scene.generatedUrl ? '' : 'hidden'} w-full h-full object-cover cursor-pointer" id="img-${scene.sceneId}" onclick="window.openLightbox(this.src)" title="í´ë¦­í•˜ì—¬ í¬ê²Œ ë³´ê¸°">
                        <div class="loading-overlay hidden absolute inset-0 bg-slate-900/80 flex items-center justify-center">
                            <i data-lucide="loader-2" class="w-4 h-4 text-blue-500 animate-spin"></i>
                        </div>
                        <!-- Drag Hint -->
                        <div class="absolute bottom-1 right-1 text-[7px] text-slate-500 bg-black/40 px-1 rounded opacity-0 group-hover:opacity-100 transition pointer-events-none">
                            ğŸ“ Drop to replace
                        </div>
                    </div>
                </td>
                <td class="py-4 pr-6 text-right w-28">
                    <div class="flex flex-col gap-2 scale-90 origin-right">
                        <button class="btn-gen-image bg-blue-600 hover:bg-blue-500 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition flex items-center justify-center gap-1" data-id="${scene.sceneId}">
                            <i data-lucide="wand-2" class="w-3.5 h-3.5"></i> ìƒì„±
                        </button>
                        <button class="btn-down-image ${scene.generatedUrl ? '' : 'hidden'} bg-slate-700 hover:bg-green-600 text-white px-3 py-1.5 rounded-lg text-xs font-bold transition flex items-center justify-center gap-1" id="btn-down-${scene.sceneId}" data-id="${scene.sceneId}">
                            <i data-lucide="download" class="w-3.5 h-3.5"></i> ë‹¤ìš´ë¡œë“œ
                        </button>
                        <button class="btn-delete-scene bg-slate-800 hover:bg-red-600 text-slate-400 hover:text-white px-3 py-1.5 rounded-lg text-xs font-bold transition flex items-center justify-center gap-1" data-id="${scene.sceneId}">
                            <i data-lucide="trash-2" class="w-3.5 h-3.5"></i> ì‚­ì œ
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');

        return `
            <div class="max-w-7xl mx-auto slide-up space-y-6">
                <!-- Toolbar -->
                <div class="flex justify-between items-center bg-slate-800/40 p-4 rounded-2xl border border-slate-700/50">
                    <div class="flex items-center gap-4">
                        <span class="text-sm font-bold text-slate-400">ì´ <b>${scenes.length}</b>ê°œ ì¥ë©´</span>
                    </div>
                    <div class="flex gap-3">
                        <button id="btn-gen-all" class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-2 rounded-xl text-sm font-bold shadow-lg shadow-indigo-600/20 transition flex items-center gap-2">
                            <i data-lucide="play" class="w-4 h-4"></i> ì „ì²´ ì¼ê´„ ì´ë¯¸ì§€ ìƒì„±
                        </button>
                        <button id="btn-down-all" class="bg-slate-700 hover:bg-green-600 text-white px-6 py-2 rounded-xl text-sm font-bold transition flex items-center gap-2">
                            <i data-lucide="download-cloud" class="w-4 h-4"></i> ì´ë¯¸ì§€ ì¼ê´„ ë‹¤ìš´ë¡œë“œ
                        </button>
                        <button id="btn-down-prompts" class="bg-slate-700 hover:bg-orange-600 text-white px-6 py-2 rounded-xl text-sm font-bold transition flex items-center gap-2">
                            <i data-lucide="file-text" class="w-4 h-4"></i> í”„ë¡¬í”„íŠ¸ ë‹¤ìš´ë¡œë“œ (TXT)
                        </button>
                    </div>
                </div>

                <!-- Table Area -->
                <div class="bg-slate-800/20 border border-slate-700/50 rounded-3xl overflow-hidden shadow-2xl">
                    <table class="w-full text-left table-fixed">
                        <thead class="bg-slate-900/60 border-b border-slate-700">
                            <tr>
                                <th class="py-4 pl-6 text-[10px] font-black text-slate-500 uppercase tracking-widest w-16">ID</th>
                                <th class="py-4 px-4 text-[10px] font-black text-slate-500 uppercase tracking-widest w-1/3">ëŒ€ë³¸(í•œê¸€)</th>
                                <th class="py-4 px-4 text-[10px] font-black text-slate-500 uppercase tracking-widest w-1/3">ì´ë¯¸ì§€ í”„ë¡¬í”„íŠ¸</th>
                                <th class="py-4 px-4 text-[10px] font-black text-slate-500 uppercase tracking-widest">ë¯¸ë¦¬ë³´ê¸° (í´ë¦­ ì‹œ í™•ëŒ€)</th>
                                <th class="py-4 pr-6 text-right text-[10px] font-black text-slate-500 uppercase tracking-widest w-24">ì•¡ì…˜</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sceneRows}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    onMount() {
        const scenes = AppState.getScenes();

        // --- ğŸ“ ì¥ë©´ ìˆ˜ë™ ì¶”ê°€ ---
        const btnAddManual = document.getElementById('btn-add-manual-scene');
        if (btnAddManual) {
            btnAddManual.addEventListener('click', () => {
                const scriptInput = document.getElementById('manual-scene-script');
                const promptInput = document.getElementById('manual-scene-prompt');

                const script = scriptInput?.value.trim();
                if (!script) return alert('ëŒ€ë³¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');

                const prompt = promptInput?.value.trim();
                const currentScenes = AppState.getScenes();
                const newId = currentScenes.length > 0 ? Math.max(...currentScenes.map(s => s.sceneId)) + 1 : 1;

                const newScene = {
                    sceneId: newId,
                    originalScript: script,
                    scriptForTTS: script,
                    imagePrompt: prompt || '',
                    motionPrompt: '',
                    generatedUrl: null,
                    videoUrl: null,
                    audioUrl: null,
                    srtData: null
                };

                AppState.setScenes([...currentScenes, newScene]);
                scriptInput.value = '';
                promptInput.value = '';
                alert(`ì¥ë©´ #${newId}ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);

                if (window.app) window.app.route('image');
            });
        }

        // --- âœï¸ ëŒ€ë³¸ ë° í”„ë¡¬í”„íŠ¸ í¸ì§‘ ë™ê¸°í™” ---
        document.querySelectorAll('.scene-script-edit').forEach(textarea => {
            textarea.addEventListener('input', (e) => {
                const sceneId = e.target.getAttribute('data-scene-id');
                const scene = AppState.getScenes().find(s => s.sceneId == sceneId);
                if (scene) {
                    scene.originalScript = e.target.value;
                    scene.scriptForTTS = e.target.value;
                }
            });
        });

        document.querySelectorAll('.scene-prompt-edit').forEach(textarea => {
            textarea.addEventListener('input', (e) => {
                const sceneId = e.target.getAttribute('data-scene-id');
                const scene = AppState.getScenes().find(s => s.sceneId == sceneId);
                if (scene) {
                    scene.imagePrompt = e.target.value;
                }
            });
        });

        // --- ğŸ—‘ï¸ ì¥ë©´ ì‚­ì œ ---
        document.querySelectorAll('.btn-delete-scene').forEach(btn => {
            btn.addEventListener('click', () => {
                const sceneId = parseInt(btn.getAttribute('data-id'));
                if (!confirm(`ì¥ë©´ #${sceneId}ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

                const currentScenes = AppState.getScenes();
                const updatedScenes = currentScenes.filter(s => s.sceneId !== sceneId);
                AppState.setScenes(updatedScenes);

                if (window.app) window.app.route('image');
            });
        });

        // --- ê°œë³„ ìƒì„± ë¡œì§ ---
        const generateItem = async (btn) => {
            const sceneId = btn.getAttribute('data-id');
            const scene = AppState.getScenes().find(s => s.sceneId == sceneId);
            const img = document.getElementById(`img-${sceneId}`);
            const placeholder = img.parentElement.querySelector('.image-placeholder');
            const loading = img.parentElement.querySelector('.loading-overlay');
            const downBtn = document.getElementById(`btn-down-${sceneId}`);

            // UI Update
            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-3.5 h-3.5 animate-spin"></i> ìš”ì²­ ì¤‘`;
            loading.classList.remove('hidden');

            try {
                console.log(`Sending request to ${CONFIG.endpoints.image} for Scene ${sceneId}`);
                const response = await fetch(CONFIG.endpoints.image, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        sceneId: sceneId,
                        prompt: scene.imagePrompt,
                        style: AppState.style,
                        ratio: AppState.ratio
                    })
                });

                const responseText = await response.text();
                console.log("Raw Response:", responseText); // Debugging

                if (!response.ok) {
                    throw new Error(`Server Error (${response.status}): ${responseText}`);
                }

                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    throw new Error(`Invalid JSON Response: ${responseText.substring(0, 100)}...`);
                }

                if (result.success === false) {
                    throw new Error(result.error || "Unknown Error from n8n");
                }

                if (result.imageUrl) {
                    img.src = result.imageUrl;
                    img.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                    downBtn.classList.remove('hidden');
                    scene.generatedUrl = result.imageUrl;
                } else {
                    throw new Error("No image URL in response");
                }

            } catch (e) {
                console.error(e);
                btn.classList.replace('bg-blue-600', 'bg-red-900');
                btn.innerText = "ì—ëŸ¬";
                // ì—ëŸ¬ ë‚´ìš©ì„ ë²„íŠ¼ íˆ´íŒì´ë‚˜ alertìœ¼ë¡œ í‘œì‹œ
                alert(`ì´ë¯¸ì§€ ìƒì„± ì‹¤íŒ¨:\n${e.message}`);
            } finally {
                btn.disabled = false;
                if (btn.innerText !== "ì—ëŸ¬") {
                    btn.innerHTML = `<i data-lucide="wand-2" class="w-3.5 h-3.5"></i> ìƒì„±`;
                    btn.classList.replace('bg-red-900', 'bg-blue-600');
                } else {
                    setTimeout(() => {
                        btn.innerHTML = `<i data-lucide="wand-2" class="w-3.5 h-3.5"></i> ìƒì„±`;
                        btn.classList.replace('bg-red-900', 'bg-blue-600');
                    }, 3000);
                }
                loading.classList.add('hidden');
                lucide.createIcons();
            }
        };

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡ ---
        document.querySelectorAll('.btn-gen-image').forEach(btn => {
            btn.addEventListener('click', () => generateItem(btn));
        });

        document.querySelectorAll('.btn-down-image').forEach(btn => {
            btn.addEventListener('click', () => {
                const sceneId = btn.getAttribute('data-id');
                const img = document.getElementById(`img-${sceneId}`);
                const link = document.createElement('a');
                link.href = img.src;
                link.download = `scene_${sceneId}.png`;
                link.click();
            });
        });

        // ì¼ê´„ ìƒì„± (ìˆœì°¨ ì²˜ë¦¬ + 5ì´ˆ ë”œë ˆì´)
        const btnGenAll = document.getElementById('btn-gen-all');
        if (btnGenAll) {
            btnGenAll.addEventListener('click', async () => {
                const btns = Array.from(document.querySelectorAll('.btn-gen-image'));
                const total = btns.length;

                // ì¼ê´„ ìƒì„± (ë³‘ë ¬ ì²˜ë¦¬ + Promise.all)
                if (!confirm(`ì´ ${total}ê°œ ì´ë¯¸ì§€ë¥¼ **ë™ì‹œì—** ìƒì„±í•©ë‹ˆë‹¤.\nì„œë²„ ë¶€í•˜ì— ë”°ë¼ ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

                btnGenAll.disabled = true;
                const originalText = btnGenAll.innerHTML;
                let completed = 0;

                const updateProgress = (count, total) => {
                    btnGenAll.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> ìƒì„± ì¤‘ (${count}/${total})`;
                    lucide.createIcons();
                };

                updateProgress(0, total);

                // Use new batch processor (Concurrency limit: 3)
                await processInBatches(btns, 3, async (btn) => {
                    await generateItem(btn);
                }, updateProgress);

                await Promise.all([]); // Compatibility cleanup

                btnGenAll.disabled = false;
                btnGenAll.innerHTML = originalText;
                lucide.createIcons();
                alert(`ì¼ê´„ ìƒì„± ì™„ë£Œ! (${total}ê°œ)`);
            });
        }

        // ì¼ê´„ ë‹¤ìš´ë¡œë“œ
        const btnDownAll = document.getElementById('btn-down-all');
        if (btnDownAll) {
            btnDownAll.addEventListener('click', () => {
                const generated = scenes.filter(s => s.generatedUrl);
                if (generated.length === 0) return alert("ë¨¼ì € ì´ë¯¸ì§€ë¥¼ ìƒì„±í•´ ì£¼ì„¸ìš”.");

                generated.forEach((s, i) => {
                    setTimeout(() => {
                        const link = document.createElement('a');
                        link.href = s.generatedUrl;
                        link.download = `scene_${s.sceneId}.png`;
                        link.click();
                    }, i * 500); // 0.5ì´ˆ ê°„ê²©ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ íŠ¸ë¦¬ê±°
                });
            });
        }

        // í”„ë¡¬í”„íŠ¸ ë‹¤ìš´ë¡œë“œ (í…ìŠ¤íŠ¸)
        const btnDownPrompts = document.getElementById('btn-down-prompts');
        if (btnDownPrompts) {
            btnDownPrompts.addEventListener('click', () => {
                let content = "";
                scenes.forEach(s => {
                    // Scene ID 2ìë¦¬ í¬ë§· (01, 02...)
                    const id = String(s.sceneId).padStart(2, '0');
                    content += `Scene${id}_${s.imagePrompt}\n\n`;
                });

                const blob = new Blob([content], { type: 'text/plain' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = "image_prompts.txt";
                link.click();
                URL.revokeObjectURL(link.href);
            });
        }

        lucide.createIcons();
    }
}

// 6. Motion Module
class MotionModule extends Module {
    constructor() {
        super('motion', 'ëª¨ì…˜ ì‘ì—…ì‹¤', 'video', 'ì •ì ì¸ ì´ë¯¸ì§€ë¥¼ ì—­ë™ì ì¸ ì˜ìƒìœ¼ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.');
    }

    render() {
        const scenes = AppState.getScenes();

        // ë…ë¦½ ì‹¤í–‰ ëª¨ë“œ: ì™¸ë¶€ ì´ë¯¸ì§€ URLë¡œ ë°”ë¡œ ë¹„ë””ì˜¤ ìƒì„±
        const standalonePanel = `
            <div class="bg-gradient-to-r from-purple-900/30 to-pink-900/30 border border-purple-500/30 rounded-2xl p-6 mb-6">
                <div class="flex items-center gap-3 mb-4">
                    <div class="p-2 bg-purple-500/20 rounded-lg text-purple-400">
                        <i data-lucide="link" class="w-5 h-5"></i>
                    </div>
                    <h3 class="text-lg font-bold text-white">ğŸ”— ì™¸ë¶€ ì´ë¯¸ì§€ë¡œ ë¹„ë””ì˜¤ ìƒì„±</h3>
                    <span class="ml-auto text-xs text-purple-400 bg-purple-500/20 px-3 py-1 rounded-full">URL ì§ì ‘ ì…ë ¥</span>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-wider block mb-2">ì´ë¯¸ì§€ URL</label>
                        <input id="external-image-url" type="url"
                            class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm text-slate-200 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition"
                            placeholder="https://example.com/image.jpg">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-wider block mb-2">ëª¨ì…˜ í”„ë¡¬í”„íŠ¸</label>
                        <input id="external-motion-prompt" type="text"
                            class="w-full bg-slate-900 border border-slate-700 rounded-xl p-3 text-sm text-slate-200 focus:ring-2 focus:ring-purple-500 focus:border-transparent transition"
                            placeholder="Slow dolly-in, smooth camera movement">
                    </div>
                </div>
                
                <button id="btn-external-gen-video" class="mt-4 w-full bg-purple-600 hover:bg-purple-500 text-white px-4 py-3 rounded-xl text-sm font-bold shadow-lg shadow-purple-600/20 transition flex items-center justify-center gap-2">
                    <i data-lucide="clapperboard" class="w-4 h-4"></i> ë¹„ë””ì˜¤ ìƒì„±
                </button>
            </div>
        `;

        if (scenes.length === 0) {
            return `
                <div class="max-w-4xl mx-auto slide-up space-y-6">
                    ${standalonePanel}
                    
                    <div class="text-center p-10 text-slate-500 border border-dashed border-slate-700 rounded-2xl">
                        <i data-lucide="video" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
                        <h3 class="text-lg font-bold">ì¥ë©´ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                        <p class="text-sm mt-2">ìœ„ì—ì„œ ì™¸ë¶€ ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ê±°ë‚˜, ë¯¸ìˆ  ì‘ì—…ì‹¤ì—ì„œ ì´ë¯¸ì§€ë¥¼ ë¨¼ì € ìƒì„±í•˜ì„¸ìš”.</p>
                    </div>
                </div>
            `;
        }

        const sceneRows = scenes.map(scene => `
            <tr class="border-b border-slate-800/30 hover:bg-white/5 transition group" id="motion-row-${scene.sceneId}">
                <td class="py-4 pl-6 text-xs font-bold text-slate-500 w-16">#${scene.sceneId}</td>
                <td class="py-4 px-4 w-1/4">
                    <div class="max-h-24 overflow-y-auto pr-2 text-sm text-slate-300 leading-relaxed scrollbar-hide">
                        ${scene.originalScript}
                    </div>
                </td>
                <td class="py-4 px-4">
                    <div class="w-32 aspect-video bg-slate-900/50 rounded-lg border border-slate-700/50 overflow-hidden relative group/img">
                        <img src="${scene.generatedUrl || ''}" class="${scene.generatedUrl ? '' : 'hidden'} w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black/40 ${scene.generatedUrl ? 'hidden' : ''} flex items-center justify-center">
                            <span class="text-[8px] text-slate-500 font-bold uppercase tracking-widest">Image Missing</span>
                        </div>
                         <!-- Lightbox Trigger -->
                        <div class="absolute inset-0 bg-black/50 opacity-0 group-hover/img:opacity-100 transition flex items-center justify-center pointer-events-none group-hover/img:pointer-events-auto">
                            ${scene.generatedUrl ? `
                                <button onclick="window.openLightbox('${scene.generatedUrl}')" class="p-1.5 bg-white/20 hover:bg-white/40 rounded-full text-white backdrop-blur-sm transition" title="í¬ê²Œ ë³´ê¸°">
                                    <i data-lucide="maximize-2" class="w-3 h-3"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </td>
                <td class="py-4 px-4 w-1/3">
                    <div class="bg-black/20 p-2 rounded-lg border border-slate-700/30">
                        <span class="text-[8px] text-purple-600 font-bold block mb-1 uppercase tracking-widest">Motion Prompt (í¸ì§‘ ê°€ëŠ¥)</span>
                        <textarea id="motion-prompt-text-${scene.sceneId}" 
                            class="w-full h-16 bg-transparent text-[11px] text-slate-400 font-mono italic resize-none focus:outline-none focus:ring-1 focus:ring-purple-500 rounded p-1 scrollbar-hide"
                            placeholder="ëª¨ì…˜ í”„ë¡¬í”„íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                            data-scene-id="${scene.sceneId}">${scene.motionPrompt || ''}</textarea>
                    </div>
                </td>
                <td class="py-4 px-4">
                    <div class="w-32 aspect-video bg-slate-900 border border-slate-700 rounded-lg flex items-center justify-center overflow-hidden relative group/video drop-zone" 
                         data-scene-id="${scene.sceneId}" 
                         data-drop-type="video"
                         ondragover="event.preventDefault(); this.classList.add('border-purple-500', 'bg-purple-500/10');" 
                         ondragleave="this.classList.remove('border-purple-500', 'bg-purple-500/10');" 
                         ondrop="window.handleAssetDrop(event, this)">
                        ${scene.videoUrl
                ? `<video src="${scene.videoUrl}" class="w-full h-full object-cover" muted></video>
                               <div class="absolute inset-0 bg-black/50 opacity-0 group-hover/video:opacity-100 transition flex items-center justify-center gap-2 pointer-events-none group-hover/video:pointer-events-auto">
                                   <button onclick="window.openVideoLightbox('${scene.videoUrl}')" class="p-2 bg-white/20 hover:bg-white/40 rounded-full text-white backdrop-blur-sm transition" title="í™•ëŒ€ ë¯¸ë¦¬ë³´ê¸°">
                                       <i data-lucide="play-circle" class="w-4 h-4"></i>
                                   </button>
                                   <button onclick="window.openLightbox('${scene.videoUrl}')" class="p-1.5 bg-white/20 hover:bg-white/40 rounded-full text-white backdrop-blur-sm transition" title="í¬ê²Œ ë³´ê¸°">
                                       <i data-lucide="maximize-2" class="w-3.5 h-3.5"></i>
                                   </button>
                               </div>`
                : `<span class="text-[8px] text-slate-600 font-bold uppercase tracking-widest">Video Pending<br><span class="text-[7px] opacity-60">Drag to Replace</span></span>`}
                        <!-- Drag Hint -->
                        <div class="absolute bottom-1 right-1 text-[7px] text-slate-500 bg-black/40 px-1 rounded opacity-0 group-hover/video:opacity-100 transition pointer-events-none">
                            ğŸ“ Drop to replace
                        </div>
                    </div>
                </td>
                <td class="py-4 pr-6 text-right w-36">
                    <div class="flex flex-col gap-2 scale-90 origin-right">
                        <button class="btn-gen-video bg-purple-600 hover:bg-purple-500 text-white px-3 py-2 rounded-lg text-xs font-bold transition flex items-center justify-center gap-1 ${scene.generatedUrl ? '' : 'opacity-50 cursor-not-allowed'}" 
                            id="btn-video-${scene.sceneId}" data-id="${scene.sceneId}" ${scene.generatedUrl ? '' : 'disabled'}>
                            <i data-lucide="clapperboard" class="w-3.5 h-3.5"></i> ë¹„ë””ì˜¤ ë³€í™˜
                        </button>
                        <button class="btn-down-video bg-slate-800 hover:bg-green-600 text-white px-3 py-2 rounded-lg text-xs font-bold transition flex items-center justify-center gap-1 ${scene.videoUrl ? '' : 'hidden'}"
                            id="btn-down-video-${scene.sceneId}" data-id="${scene.sceneId}" onclick="const link = document.createElement('a'); link.href = '${scene.videoUrl}'; link.download = 'scene_${scene.sceneId}.mp4'; link.click();">
                            <i data-lucide="download" class="w-3.5 h-3.5"></i> ì˜ìƒ ë‹¤ìš´ë¡œë“œ
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');

        return `
            <div class="max-w-7xl mx-auto slide-up space-y-6">
                <!-- Toolbar -->
                <div class="flex justify-between items-center bg-slate-800/40 p-4 rounded-2xl border border-slate-700/50">
                    <div class="flex items-center gap-4">
                        <span class="text-sm font-bold text-slate-400">ì´ <b>${scenes.length}</b>ê°œ ì¥ë©´</span>
                        <div class="h-6 w-px bg-slate-700"></div>
                        <div class="flex items-center gap-2">
                            <span class="text-xs font-bold text-slate-500 uppercase">Range</span>
                            <input type="number" id="motion-range-start" class="w-16 bg-slate-900 border border-slate-700 rounded-lg px-2 py-1 text-sm text-center font-bold text-white focus:outline-none focus:border-purple-500" value="1" min="1" max="${scenes.length}">
                            <span class="text-slate-500 font-bold">-</span>
                            <input type="number" id="motion-range-end" class="w-16 bg-slate-900 border border-slate-700 rounded-lg px-2 py-1 text-sm text-center font-bold text-white focus:outline-none focus:border-purple-500" value="${scenes.length}" min="1" max="${scenes.length}">
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button id="btn-gen-motion-batch" class="bg-purple-600 hover:bg-purple-500 text-white px-6 py-2 rounded-xl text-sm font-bold shadow-lg shadow-purple-600/20 transition flex items-center gap-2">
                            <i data-lucide="layers" class="w-4 h-4"></i> í”„ë¡¬í”„íŠ¸ ì¼ê´„ ìƒì„±
                        </button>
                        <button id="btn-gen-motion-video-batch" class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-2 rounded-xl text-sm font-bold shadow-lg shadow-indigo-600/20 transition flex items-center gap-2">
                            <i data-lucide="film" class="w-4 h-4"></i> ë¹„ë””ì˜¤ ì¼ê´„ ìƒì„±
                        </button>
                        <button id="btn-down-motion-prompts" class="bg-slate-700 hover:bg-orange-600 text-white px-6 py-2 rounded-xl text-sm font-bold transition flex items-center gap-2">
                            <i data-lucide="file-text" class="w-4 h-4"></i> í”„ë¡¬í”„íŠ¸ ë‹¤ìš´ë¡œë“œ (TXT)
                        </button>
                        <button id="btn-down-motion-videos" class="bg-slate-700 hover:bg-green-600 text-white px-6 py-2 rounded-xl text-sm font-bold transition flex items-center gap-2">
                            <i data-lucide="download-cloud" class="w-4 h-4"></i> ì˜ìƒ ì¼ê´„ ë‹¤ìš´ë¡œë“œ
                        </button>
                    </div>
                </div>

                 <div class="bg-slate-800/20 border border-slate-700/50 rounded-3xl overflow-hidden shadow-2xl">
                    <table class="w-full text-left table-fixed">
                        <thead class="bg-slate-900/60 border-b border-slate-700">
                            <tr>
                                <th class="py-4 pl-6 text-[10px] font-black text-slate-500 uppercase tracking-widest w-16">ID</th>
                                <th class="py-4 px-4 text-[10px] font-black text-slate-500 uppercase tracking-widest w-1/4">ëŒ€ë³¸(í•œê¸€)</th>
                                <th class="py-4 px-4 text-[10px] font-black text-slate-500 uppercase tracking-widest">ìƒì„± ì´ë¯¸ì§€</th>
                                <th class="py-4 px-4 text-[10px] font-black text-slate-500 uppercase tracking-widest w-1/4">ëª¨ì…˜ ì„¤ì •</th>
                                <th class="py-4 px-4 text-[10px] font-black text-slate-500 uppercase tracking-widest">ìµœì¢… ì˜ìƒ</th>
                                <th class="py-4 pr-6 text-right text-[10px] font-black text-slate-500 uppercase tracking-widest w-36">ì•¡ì…˜</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sceneRows}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    onMount() {
        const scenes = AppState.getScenes();

        // --- ğŸ”— ì™¸ë¶€ ì´ë¯¸ì§€ URLë¡œ ë¹„ë””ì˜¤ ìƒì„± ---
        const btnExternalGen = document.getElementById('btn-external-gen-video');
        if (btnExternalGen) {
            btnExternalGen.addEventListener('click', async () => {
                const imageUrl = document.getElementById('external-image-url')?.value.trim();
                const motionPrompt = document.getElementById('external-motion-prompt')?.value.trim();

                if (!imageUrl) return alert('ì´ë¯¸ì§€ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');

                btnExternalGen.disabled = true;
                const originalText = btnExternalGen.innerHTML;
                btnExternalGen.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> ìƒì„± ì¤‘...`;
                lucide.createIcons();

                try {
                    const response = await fetch(CONFIG.endpoints.motion, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            sceneId: 'external',
                            imageUrl: imageUrl,
                            motionPrompt: motionPrompt || 'Slow dolly-in, smooth camera movement'
                        })
                    });

                    if (!response.ok) throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);

                    const result = await response.json();
                    if (result.videoUrl) {
                        const link = document.createElement('a');
                        link.href = result.videoUrl;
                        link.download = 'external_video.mp4';
                        link.click();
                        alert('ë¹„ë””ì˜¤ ìƒì„± ì™„ë£Œ! ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë©ë‹ˆë‹¤.');
                    } else {
                        throw new Error('ë¹„ë””ì˜¤ URLì´ ì—†ìŠµë‹ˆë‹¤.');
                    }
                } catch (e) {
                    console.error(e);
                    alert(`ë¹„ë””ì˜¤ ìƒì„± ì‹¤íŒ¨: ${e.message}`);
                } finally {
                    btnExternalGen.disabled = false;
                    btnExternalGen.innerHTML = originalText;
                    lucide.createIcons();
                }
            });
        }

        // ëª¨ì…˜ í”„ë¡¬í”„íŠ¸ í¸ì§‘ ì‹œ ìƒíƒœ ë™ê¸°í™”
        document.querySelectorAll('textarea[id^="motion-prompt-text-"]').forEach(textarea => {
            textarea.addEventListener('input', (e) => {
                const sceneId = e.target.getAttribute('data-scene-id');
                const scene = scenes.find(s => s.sceneId == sceneId);
                if (scene) {
                    scene.motionPrompt = e.target.value;
                }
            });
        });

        // êµ¬ê°„ ì¼ê´„ ìƒì„±
        const btnGenBatch = document.getElementById('btn-gen-motion-batch');
        if (btnGenBatch) {
            btnGenBatch.addEventListener('click', async () => {
                const start = parseInt(document.getElementById('motion-range-start').value);
                const end = parseInt(document.getElementById('motion-range-end').value);

                if (isNaN(start) || isNaN(end) || start < 1 || end > scenes.length || start > end) {
                    return alert(`ìœ íš¨í•œ ë²”ìœ„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (1 ~ ${scenes.length})`);
                }

                const targetScenes = scenes.filter(s => s.sceneId >= start && s.sceneId <= end);
                if (targetScenes.length === 0) return alert("ì„ íƒëœ ë²”ìœ„ì— ì¥ë©´ì´ ì—†ìŠµë‹ˆë‹¤.");

                if (!confirm(`Scene ${start} ë¶€í„° ${end} ê¹Œì§€ ì´ ${targetScenes.length}ê°œì˜ ëª¨ì…˜ í”„ë¡¬í”„íŠ¸ë¥¼ **ë™ì‹œì—** ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

                btnGenBatch.disabled = true;
                const originalText = btnGenBatch.innerHTML;
                let completed = 0;

                const updateProgress = (count, total) => {
                    btnGenBatch.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> ë¶„ì„ ì¤‘ (${count}/${targetScenes.length})`;
                    lucide.createIcons();
                };
                updateProgress(0, targetScenes.length);

                // Use batch processor (Concurrency limit: 5)
                await processInBatches(targetScenes, 5, async (scene) => {
                    const btn = document.querySelector(`.btn-gen-motion-prompt[data-id="${scene.sceneId}"]`);
                    if (btn) {
                        await generateMotionPrompt(btn);
                    }
                }, updateProgress);

                btnGenBatch.disabled = false;
                btnGenBatch.innerHTML = originalText;
                lucide.createIcons();
                alert(`êµ¬ê°„ ì¼ê´„ ìƒì„± ì™„ë£Œ! (${targetScenes.length}ê°œ)`);
            });
        }

        // ë¹„ë””ì˜¤ ì¼ê´„ ìƒì„± (ë³‘ë ¬)
        const btnGenVideoBatch = document.getElementById('btn-gen-motion-video-batch');
        if (btnGenVideoBatch) {
            btnGenVideoBatch.addEventListener('click', async () => {
                const start = parseInt(document.getElementById('motion-range-start').value);
                const end = parseInt(document.getElementById('motion-range-end').value);

                if (isNaN(start) || isNaN(end) || start < 1 || end > scenes.length || start > end) {
                    return alert(`ìœ íš¨í•œ ë²”ìœ„ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (1 ~ ${scenes.length})`);
                }

                const targetScenes = scenes.filter(s => s.sceneId >= start && s.sceneId <= end);
                if (targetScenes.length === 0) return alert("ì„ íƒëœ ë²”ìœ„ì— ì¥ë©´ì´ ì—†ìŠµë‹ˆë‹¤.");

                const validScenes = targetScenes.filter(s => s.generatedUrl && s.motionPrompt);
                if (validScenes.length === 0) return alert("ì„ íƒëœ ë²”ìœ„ì— ìƒì„± ê°€ëŠ¥í•œ ì¥ë©´ì´ ì—†ìŠµë‹ˆë‹¤.\n(ì´ë¯¸ì§€ì™€ ëª¨ì…˜ í”„ë¡¬í”„íŠ¸ê°€ í•„ìš”í•©ë‹ˆë‹¤)");

                if (!confirm(`Scene ${start} ë¶€í„° ${end} ê¹Œì§€ ìƒì„± ê°€ëŠ¥í•œ ${validScenes.length}ê°œì˜ ë¹„ë””ì˜¤ë¥¼ **ë™ì‹œì—** ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n(ì£¼ì˜: ëª¨ì…˜ ë¹„ë””ì˜¤ ìƒì„±ì€ ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦¬ë©° ì„œë²„ ë¶€í•˜ê°€ ë†’ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤)`)) return;

                btnGenVideoBatch.disabled = true;
                const originalText = btnGenVideoBatch.innerHTML;
                let completed = 0;

                const updateProgress = (count, total) => {
                    btnGenVideoBatch.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> ìƒì„± ì¤‘ (${count}/${validScenes.length})`;
                    lucide.createIcons();
                };
                updateProgress(0, validScenes.length);

                // Batch Process for Video (Limit 2 - heavy)
                await processInBatches(validScenes, 2, async (scene) => {
                    const btn = document.querySelector(`#btn-video-${scene.sceneId}`);
                    if (!btn) return;

                    try {
                        const sceneId = scene.sceneId;
                        console.log(`Starting Batch Motion for Scene ${sceneId}`);

                        const response = await fetch(CONFIG.endpoints.motion, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                sceneId: sceneId,
                                imageUrl: scene.generatedUrl,
                                motionPrompt: scene.motionPrompt,
                                duration: 5,
                                aspectRatio: AppState.ratio || '16:9'
                            })
                        });

                        if (!response.ok) throw new Error('Failed');
                        const result = await response.json();

                        if (result.videoUrl) {
                            scene.videoUrl = result.videoUrl;
                            // Update UI
                            const videoContainer = document.querySelector(`#motion-row-${sceneId} td:nth-child(5) div`);
                            if (videoContainer) {
                                videoContainer.innerHTML = `<video src="${result.videoUrl}" class="w-full h-full object-cover cursor-pointer" onclick="window.openLightbox(this.src)" title="í´ë¦­í•˜ì—¬ í¬ê²Œ ë³´ê¸°"></video>`;
                                // Restore drag handlers
                                videoContainer.setAttribute('ondragover', "event.preventDefault(); this.classList.add('border-purple-500', 'bg-purple-500/10');");
                                videoContainer.setAttribute('ondragleave', "this.classList.remove('border-purple-500', 'bg-purple-500/10');");
                                videoContainer.setAttribute('ondrop', 'window.handleAssetDrop(event, this)');
                            }
                            const downBtn = document.getElementById(`btn-down-video-${sceneId}`);
                            if (downBtn) downBtn.classList.remove('hidden');
                        }
                    } catch (e) { console.error(`Batch Scene ${scene.sceneId} failed`, e); }
                }, updateProgress);

                await Promise.all([]); // Compatibility cleanup

                btnGenVideoBatch.disabled = false;
                btnGenVideoBatch.innerHTML = originalText;
                lucide.createIcons();
                alert(`ë¹„ë””ì˜¤ ì¼ê´„ ìƒì„± ì™„ë£Œ! (${validScenes.length}ê°œ ì‹œë„)`);
            });
        }

        // í”„ë¡¬í”„íŠ¸ ë‹¤ìš´ë¡œë“œ (TXT)
        const btnDownPrompts = document.getElementById('btn-down-motion-prompts');
        if (btnDownPrompts) {
            btnDownPrompts.addEventListener('click', () => {
                let content = "";
                scenes.forEach(s => {
                    const id = String(s.sceneId).padStart(2, '0');
                    const prompt = s.motionPrompt || "ëª¨ì…˜ í”„ë¡¬í”„íŠ¸ê°€ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.";
                    content += `Scene${id}_${prompt}\n\n`;
                });

                const blob = new Blob([content], { type: 'text/plain' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = "motion_prompts.txt";
                link.click();
                URL.revokeObjectURL(link.href);
            });
        }

        // ë¹„ë””ì˜¤ ì¼ê´„ ë‹¤ìš´ë¡œë“œ
        const btnDownVideos = document.getElementById('btn-down-motion-videos');
        if (btnDownVideos) {
            btnDownVideos.addEventListener('click', () => {
                const scenesWithVideo = scenes.filter(s => s.videoUrl);
                if (scenesWithVideo.length === 0) return alert("ìƒì„±ëœ ì˜ìƒì´ ì—†ìŠµë‹ˆë‹¤.");

                if (!confirm(`ì´ ${scenesWithVideo.length}ê°œì˜ ì˜ìƒì„ ë‹¤ìš´ë¡œë“œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

                scenesWithVideo.forEach((s, i) => {
                    setTimeout(() => {
                        const link = document.createElement('a');
                        link.href = s.videoUrl;
                        link.download = `scene_${s.sceneId}.mp4`;
                        link.click();
                    }, i * 1000); // 1ì´ˆ ê°„ê²©ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œ
                });
            });
        }

        document.querySelectorAll('.btn-gen-video').forEach(btn => {
            btn.addEventListener('click', async () => {
                const sceneId = btn.getAttribute('data-id');
                const scene = scenes.find(s => s.sceneId == sceneId);

                // í•„ìˆ˜ ì¡°ê±´ ì²´í¬
                if (!scene.generatedUrl) {
                    return alert("ì´ë¯¸ì§€ê°€ ë¨¼ì € ìƒì„±ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.");
                }
                if (!scene.motionPrompt) {
                    return alert("ëª¨ì…˜ í”„ë¡¬í”„íŠ¸ë¥¼ ë¨¼ì € ìƒì„±í•´ ì£¼ì„¸ìš”.");
                }

                const videoPreview = document.querySelector(`#motion-row-${sceneId} video`);
                const videoContainer = videoPreview?.parentElement;
                const downBtn = document.getElementById(`btn-down-video-${sceneId}`);

                btn.disabled = true;
                const originalText = btn.innerHTML;
                btn.innerHTML = `<i data-lucide="loader-2" class="w-3.5 h-3.5 animate-spin"></i> ìƒì„± ì¤‘...`;
                lucide.createIcons();

                try {
                    console.log(`Sending motion request for Scene ${sceneId}`);
                    const response = await fetch(CONFIG.endpoints.motion, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            sceneId: sceneId,
                            imageUrl: scene.generatedUrl,
                            motionPrompt: scene.motionPrompt,
                            duration: 5,
                            aspectRatio: AppState.ratio || '16:9'
                        })
                    });

                    const responseText = await response.text();
                    console.log("Motion Response:", responseText);

                    if (!response.ok) {
                        throw new Error(`Server Error (${response.status}): ${responseText}`);
                    }

                    let result;
                    try {
                        result = JSON.parse(responseText);
                    } catch (e) {
                        throw new Error(`Invalid JSON Response: ${responseText.substring(0, 100)}...`);
                    }

                    if (result.success === false) {
                        throw new Error(result.error || "Unknown Error from n8n");
                    }

                    if (result.videoUrl) {
                        scene.videoUrl = result.videoUrl;

                        // ë¹„ë””ì˜¤ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
                        if (videoContainer) {
                            videoContainer.innerHTML = `<video src="${result.videoUrl}" class="w-full h-full object-cover" controls></video>`;
                        }

                        // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ë³´ì´ê¸°
                        if (downBtn) {
                            downBtn.classList.remove('hidden');
                            downBtn.setAttribute('onclick', `const link = document.createElement('a'); link.href = '${result.videoUrl}'; link.download = 'scene_${sceneId}.mp4'; link.click();`);
                        }

                        alert(`Scene ${sceneId} ë¹„ë””ì˜¤ ìƒì„± ì™„ë£Œ!`);
                    } else {
                        throw new Error("No videoUrl in response");
                    }
                } catch (e) {
                    console.error(e);
                    alert(`ë¹„ë””ì˜¤ ìƒì„± ì‹¤íŒ¨: ${e.message}`);
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    lucide.createIcons();
                }
            });
        });

        lucide.createIcons();
    }
}

// 7. TTS Module
class TTSModule extends Module {
    constructor() {
        super('tts', 'TTS ë…¹ìŒì‹¤', 'mic-2', 'ElevenLabs ìŒì„± í•©ì„± ë° íƒ€ì„ë¼ì¸ ìƒì„±');
        this.voiceSettings = {
            voiceId: 'zcAOhNBS3c14rBihAFp1', // Default: Michael
            stability: 0.5,
            similarity: 0.75,
            speed: 1.0
        };
        this.isPlayingAll = false;
    }

    render() {
        const scenes = AppState.getScenes();

        // ë…ë¦½ ì‹¤í–‰ ëª¨ë“œ: ì¥ë©´ì´ ì—†ì–´ë„ ì§ì ‘ TTS ìƒì„± ê°€ëŠ¥
        const standalonePanel = `
            <div class="bg-gradient-to-r from-blue-900/30 to-purple-900/30 border border-blue-500/30 rounded-2xl p-6 mb-6">
                <div class="flex items-center gap-3 mb-4">
                    <div class="p-2 bg-blue-500/20 rounded-lg text-blue-400">
                        <i data-lucide="zap" class="w-5 h-5"></i>
                    </div>
                    <h3 class="text-lg font-bold text-white">ğŸš€ ë…ë¦½ ì‹¤í–‰ ëª¨ë“œ</h3>
                    <span class="ml-auto text-xs text-blue-400 bg-blue-500/20 px-3 py-1 rounded-full">ë¶„ì„ ì—†ì´ ë°”ë¡œ TTS</span>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="text-xs font-bold text-slate-400 uppercase tracking-wider block mb-2">ëŒ€ë³¸ ì§ì ‘ ì…ë ¥</label>
                        <textarea id="standalone-tts-input" 
                            class="w-full h-32 bg-slate-900 border border-slate-700 rounded-xl p-4 text-sm text-slate-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition resize-none scrollbar-hide"
                            placeholder="ì—¬ê¸°ì— ëŒ€ë³¸ì„ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”. ì¤„ë°”ê¿ˆìœ¼ë¡œ ì—¬ëŸ¬ í•­ëª©ì„ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."></textarea>
                        <div class="flex justify-between text-xs text-slate-500 px-1 mt-1">
                            <span><i data-lucide="info" class="w-3 h-3 inline"></i> ì¤„ë°”ê¿ˆ(Enter)ìœ¼ë¡œ ì—¬ëŸ¬ TTS í•­ëª© ë¶„ë¦¬</span>
                            <span id="standalone-char-count">0ì</span>
                        </div>
                    </div>
                    
                    <div class="flex gap-3">
                        <button id="btn-standalone-add-items" class="flex-1 bg-slate-700 hover:bg-slate-600 text-white px-4 py-3 rounded-xl text-sm font-bold transition flex items-center justify-center gap-2">
                            <i data-lucide="plus-circle" class="w-4 h-4"></i> ëª©ë¡ì— ì¶”ê°€
                        </button>
                        <button id="btn-standalone-tts-gen" class="flex-1 bg-blue-600 hover:bg-blue-500 text-white px-4 py-3 rounded-xl text-sm font-bold shadow-lg shadow-blue-600/20 transition flex items-center justify-center gap-2">
                            <i data-lucide="mic" class="w-4 h-4"></i> ì¦‰ì‹œ TTS ìƒì„±
                        </button>
                    </div>
                </div>
            </div>
        `;

        if (scenes.length === 0) {
            return `
                <div class="max-w-4xl mx-auto slide-up space-y-6">
                    ${standalonePanel}
                    
                    <!-- Empty State Hint -->
                    <div class="text-center p-10 text-slate-500 border border-dashed border-slate-700 rounded-2xl">
                        <i data-lucide="list-plus" class="w-12 h-12 mx-auto mb-4 opacity-50"></i>
                        <h3 class="text-lg font-bold">TTS í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                        <p class="text-sm mt-2">ìœ„ ì…ë ¥ì°½ì—ì„œ ëŒ€ë³¸ì„ ì…ë ¥í•˜ê³  "ëª©ë¡ì— ì¶”ê°€" ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</p>
                        <p class="text-xs mt-1 text-slate-600">ë˜ëŠ” ëŒ€ë³¸ ë¶„ì„ì‹¤ì—ì„œ ì¥ë©´ ë¶„í• ì„ ë¨¼ì € ì§„í–‰í•˜ì„¸ìš”.</p>
                    </div>
                </div>
            `;
        }

        const sceneRows = scenes.map(scene => `
            <tr class="border-b border-slate-800/50 hover:bg-white/5 transition group" id="tts-row-${scene.sceneId}">
                <td class="py-4 pl-4 text-xs font-bold text-slate-500 align-top pt-6">#${scene.sceneId}</td>
                <td class="py-4 px-4 w-1/2">
                    <div class="flex flex-col gap-2">
                        <textarea id="tts-script-${scene.sceneId}" 
                            class="w-full bg-slate-900/50 border border-slate-700 rounded-lg p-3 text-sm text-slate-200 focus:ring-2 focus:ring-blue-500 focus:border-transparent transition resize-none h-24 scrollbar-hide"
                            placeholder="ëŒ€ë³¸ì„ ì…ë ¥í•˜ì„¸ìš”...">${scene.scriptForTTS || scene.originalScript}</textarea>
                        <div class="flex justify-between text-xs text-slate-500 px-1">
                            <span><i data-lucide="edit-3" class="w-3 h-3 inline"></i> í¸ì§‘ ê°€ëŠ¥</span>
                            <span id="tts-char-count-${scene.sceneId}">${(scene.scriptForTTS || scene.originalScript).length}ì</span>
                        </div>
                    </div>
                </td>
                <td class="py-4 px-4 align-top pt-6">
                    <div class="flex flex-col gap-3">
                         <div class="bg-black/30 rounded-lg p-3 border border-slate-700/50 min-h-[60px] flex flex-col justify-center items-center relative" id="audio-container-${scene.sceneId}">
                            ${scene.audioUrl
                ? `<audio src="${scene.audioUrl}" controls class="w-full h-8" id="audio-player-${scene.sceneId}"></audio>
                                   <div class="mt-2 flex gap-2 w-full">
                                        <div class="flex-1 bg-green-900/30 text-green-400 text-[10px] font-mono px-2 py-1 rounded border border-green-500/30 flex items-center justify-center gap-1">
                                            <i data-lucide="check-circle-2" class="w-3 h-3"></i> Audio Ready
                                        </div>
                                        ${scene.alignmentData
                    ? `<div class="flex-1 bg-purple-900/30 text-purple-400 text-[10px] font-mono px-2 py-1 rounded border border-purple-500/30 flex items-center justify-center gap-1" title="Word Timestamps Available">
                                                <i data-lucide="clock" class="w-3 h-3"></i> Sync Data
                                               </div>`
                    : `<div class="flex-1 bg-slate-800 text-slate-600 text-[10px] font-mono px-2 py-1 rounded border border-slate-700 flex items-center justify-center gap-1 opacity-50">
                                                No Sync Data
                                               </div>`
                }
                                   </div>`
                : `<span class="text-xs text-slate-600">ì˜¤ë””ì˜¤ ë¯¸ìƒì„±</span>`
            }
                        </div>
                    </div>
                </td>
                <td class="py-4 pr-6 text-right w-32 align-top pt-6">
                     <button class="btn-gen-tts w-full bg-slate-700 hover:bg-blue-600 text-white px-3 py-2 rounded-lg text-xs font-bold transition flex items-center justify-center gap-2 mb-2" 
                        data-id="${scene.sceneId}">
                        <i data-lucide="mic" class="w-3.5 h-3.5"></i> ìƒì„±
                    </button>
                    ${scene.audioUrl ? `
                    <button onclick="const a = document.createElement('a'); a.href='${scene.audioUrl}'; a.download='voice_${scene.sceneId}.mp3'; a.click();" 
                        class="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 px-3 py-2 rounded-lg text-[10px] font-bold transition flex items-center justify-center gap-2">
                        <i data-lucide="download" class="w-3 h-3"></i> ë‹¤ìš´ë¡œë“œ
                    </button>` : ''}
                </td>
            </tr>
        `).join('');

        return `
            <div class="max-w-6xl mx-auto slide-up space-y-6">
                
                <!-- 1. Voice Settings Panel (Global) -->
                <div class="bg-slate-800/60 border border-slate-700 rounded-2xl p-6 shadow-xl backdrop-blur-sm">
                    <div class="flex items-center gap-3 mb-4 border-b border-slate-700 pb-4">
                        <div class="p-2 bg-blue-500/20 rounded-lg text-blue-400">
                            <i data-lucide="sliders" class="w-5 h-5"></i>
                        </div>
                        <h3 class="text-lg font-bold text-white">ë³´ì´ìŠ¤ ì„¤ì • (Global Settings)</h3>
                        <span class="text-xs text-slate-400 ml-auto">* ëª¨ë“  ì¥ë©´ì— ì¼ê´„ ì ìš©ë©ë‹ˆë‹¤.</span>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <!-- Voice ID Selector -->
                        <div class="space-y-2 col-span-2">
                            <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Voice Actor (Korean Optimized)</label>
                            <select id="tts-voice-id" class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 text-sm text-white focus:ring-2 focus:ring-blue-500 outline-none">
                                <option value="zcAOhNBS3c14rBihAFp1" selected>Michael (Standard Male / ì°¨ë¶„í•¨)</option>
                                <option value="EXAVITQu4vr4xnSDxMaL">Sarah (Professional Female / ì „ë¬¸ê°€)</option>
                                <option value="JBFQNCBsd6RMkjVDRZzb">George (Narration / ê¹Šì€ ìš¸ë¦¼)</option>
                                <option value="FGY2WhTYq4uDQk601ULg">Nicole (Whisper / ê°ì„±ì )</option>
                                <option value="Xb7hH8MSUJpSbSDYk0k2">Alice (News Anchor / ë‰´ìŠ¤ í†¤)</option>
                            </select>
                        </div>

                        <!-- Stability Slider -->
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Stability</label>
                                <span id="val-stability" class="text-xs font-mono text-blue-400">${this.voiceSettings.stability}</span>
                            </div>
                            <input type="range" id="rng-stability" min="0" max="1" step="0.05" value="${this.voiceSettings.stability}" 
                                class="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500">
                        </div>

                        <!-- Speed Slider -->
                        <div class="space-y-2">
                            <div class="flex justify-between">
                                <label class="text-xs font-bold text-slate-400 uppercase tracking-wider">Speed</label>
                                <span id="val-speed" class="text-xs font-mono text-blue-400">${this.voiceSettings.speed}x</span>
                            </div>
                            <input type="range" id="rng-speed" min="0.5" max="2.0" step="0.1" value="${this.voiceSettings.speed}" 
                                class="w-full h-1 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500">
                        </div>
                    </div>
                </div>

                <!-- 2. Action Toolbar -->
                <div class="flex justify-between items-center bg-slate-800/40 p-4 rounded-2xl border border-slate-700/50">
                    <div class="flex items-center gap-4">
                        <span class="text-sm font-bold text-slate-400">ì´ <b>${scenes.length}</b>ê°œ ìŠ¤í¬ë¦½íŠ¸</span>
                    </div>
                    <div class="flex gap-3">
                        <button id="btn-tts-play-all" class="bg-slate-700 hover:bg-green-600 text-white px-6 py-2 rounded-xl text-sm font-bold transition flex items-center gap-2">
                            <i data-lucide="play-circle" class="w-4 h-4"></i> ì „ì²´ ì´ì–´ë“£ê¸°
                        </button>
                         <button id="btn-tts-gen-all" class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-2 rounded-xl text-sm font-bold shadow-lg shadow-indigo-600/20 transition flex items-center gap-2">
                            <i data-lucide="zap" class="w-4 h-4"></i> ì „ì²´ ì¼ê´„ ìƒì„±
                        </button>
                    </div>
                </div>

                <!-- 3. Scripts List -->
                <div class="bg-slate-800/20 border border-slate-700/50 rounded-3xl overflow-hidden shadow-2xl">
                    <table class="w-full text-left">
                        <thead class="bg-slate-900/60 border-b border-slate-700">
                            <tr>
                                <th class="py-4 pl-4 text-[10px] font-black text-slate-500 uppercase tracking-widest w-16">ID</th>
                                <th class="py-4 px-4 text-[10px] font-black text-slate-500 uppercase tracking-widest w-1/2">ëŒ€ë³¸ í¸ì§‘ (ì‹¤ì œ ë°œìŒìš©)</th>
                                <th class="py-4 px-4 text-[10px] font-black text-slate-500 uppercase tracking-widest">ì˜¤ë””ì˜¤ ë° ì‹±í¬ ë°ì´í„°</th>
                                <th class="py-4 pr-6 text-right text-[10px] font-black text-slate-500 uppercase tracking-widest w-32">ì•¡ì…˜</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sceneRows}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    onMount() {
        const scenes = AppState.getScenes();
        const self = this; // Capture 'this' for event listeners

        // --- ğŸš€ Standalone TTS ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ---
        const standaloneInput = document.getElementById('standalone-tts-input');
        const standaloneCharCount = document.getElementById('standalone-char-count');
        const btnAddItems = document.getElementById('btn-standalone-add-items');
        const btnStandaloneTts = document.getElementById('btn-standalone-tts-gen');

        if (standaloneInput) {
            // ê¸€ì ìˆ˜ ì¹´ìš´í„°
            standaloneInput.addEventListener('input', () => {
                if (standaloneCharCount) {
                    standaloneCharCount.innerText = `${standaloneInput.value.length}ì`;
                }
            });
        }

        if (btnAddItems) {
            btnAddItems.addEventListener('click', () => {
                const text = standaloneInput?.value.trim();
                if (!text) return alert('ëŒ€ë³¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');

                // ì¤„ë°”ê¿ˆìœ¼ë¡œ ë¶„ë¦¬í•˜ì—¬ ì—¬ëŸ¬ í•­ëª© ì¶”ê°€
                const lines = text.split('\n').filter(line => line.trim());
                const currentScenes = AppState.getScenes();
                const startId = currentScenes.length > 0 ? Math.max(...currentScenes.map(s => s.sceneId)) + 1 : 1;

                const newScenes = lines.map((line, index) => ({
                    sceneId: startId + index,
                    originalScript: line.trim(),
                    scriptForTTS: line.trim(),
                    imagePrompt: '',
                    motionPrompt: '',
                    generatedUrl: null,
                    videoUrl: null,
                    audioUrl: null,
                    srtData: null
                }));

                AppState.setScenes([...currentScenes, ...newScenes]);
                standaloneInput.value = '';
                alert(`${newScenes.length}ê°œì˜ TTS í•­ëª©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.`);

                // Re-render the module
                if (window.app) window.app.route('tts');
            });
        }

        if (btnStandaloneTts) {
            btnStandaloneTts.addEventListener('click', async () => {
                const text = standaloneInput?.value.trim();
                if (!text) return alert('ëŒ€ë³¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');

                btnStandaloneTts.disabled = true;
                const originalText = btnStandaloneTts.innerHTML;
                btnStandaloneTts.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> ìƒì„± ì¤‘...`;
                lucide.createIcons();

                try {
                    const payload = {
                        sceneId: 'standalone',
                        text: text,
                        settings: self.voiceSettings
                    };

                    const response = await fetch(CONFIG.endpoints.tts, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status}`);

                    const result = await response.json();
                    if (result.audioUrl) {
                        // ì˜¤ë””ì˜¤ ë‹¤ìš´ë¡œë“œ
                        const link = document.createElement('a');
                        link.href = result.audioUrl;
                        link.download = 'standalone_tts.mp3';
                        link.click();
                        alert('TTS ìƒì„± ì™„ë£Œ! ë‹¤ìš´ë¡œë“œê°€ ì‹œì‘ë©ë‹ˆë‹¤.');
                    } else {
                        throw new Error('ì˜¤ë””ì˜¤ URLì´ ì—†ìŠµë‹ˆë‹¤.');
                    }
                } catch (e) {
                    console.error(e);
                    alert(`TTS ìƒì„± ì‹¤íŒ¨: ${e.message}`);
                } finally {
                    btnStandaloneTts.disabled = false;
                    btnStandaloneTts.innerHTML = originalText;
                    lucide.createIcons();
                }
            });
        }

        // --- Settings Event Listeners ---
        const updateSetting = (key, val, displayId) => {
            if (key === 'voiceId') val = String(val); // VoiceId string
            else val = parseFloat(val); // Numbers

            this.voiceSettings[key] = val;
            if (displayId) {
                const el = document.getElementById(displayId);
                if (el) el.innerText = key === 'speed' ? val + 'x' : val;
            }
            console.log("Updated Voice Settings:", this.voiceSettings);
        };

        const selVoice = document.getElementById('tts-voice-id');
        if (selVoice) {
            selVoice.value = this.voiceSettings.voiceId; // Set stored value
            selVoice.addEventListener('change', (e) => updateSetting('voiceId', e.target.value));
        }

        const rngStability = document.getElementById('rng-stability');
        if (rngStability) rngStability.addEventListener('input', (e) => updateSetting('stability', e.target.value, 'val-stability'));

        const rngSpeed = document.getElementById('rng-speed');
        if (rngSpeed) rngSpeed.addEventListener('input', (e) => updateSetting('speed', e.target.value, 'val-speed'));


        // --- Helper: Generate TTS ---
        const generateTTS = async (sceneId, btn) => {
            const scene = AppState.getScenes().find(s => s.sceneId == sceneId);
            const textArea = document.getElementById(`tts-script-${sceneId}`);
            const updatedScript = textArea.value.trim();
            const audioContainer = document.getElementById(`audio-container-${sceneId}`);

            // Save the updated script to state
            scene.scriptForTTS = updatedScript;

            if (!updatedScript) return alert("ëŒ€ë³¸ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.");

            const originalBtnHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-3.5 h-3.5 animate-spin"></i> ìƒì„± ì¤‘`;
            lucide.createIcons();

            try {
                // Send Global Settings along with request
                const payload = {
                    sceneId: sceneId,
                    text: updatedScript,
                    settings: this.voiceSettings // { voiceId, stability, speed }
                };

                console.log("Sending TTS Request:", payload);

                const response = await fetch(CONFIG.endpoints.tts, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // ì‘ë‹µ ë³¸ë¬¸ ë¨¼ì € ì½ê¸°
                const responseText = await response.text();

                if (!response.ok) {
                    let errorDetail = responseText;
                    try {
                        const json = JSON.parse(responseText);
                        errorDetail = json.error || json.message || responseText;
                    } catch (e) { }

                    // UI Error State: Highlight script area
                    textArea.classList.add('border-red-500', 'bg-red-900/10');
                    setTimeout(() => textArea.classList.remove('border-red-500', 'bg-red-900/10'), 5000);

                    throw new Error(`Server Error (${response.status}): ${errorDetail}`);
                }

                // ë¹ˆ ì‘ë‹µ í™•ì¸
                if (!responseText || responseText.trim() === '') {
                    throw new Error('TTS ì„œë²„ì—ì„œ ë¹ˆ ì‘ë‹µì„ ë°›ì•˜ìŠµë‹ˆë‹¤. n8n ì›Œí¬í”Œë¡œìš°ë¥¼ í™•ì¸í•˜ì„¸ìš”.');
                }

                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (e) {
                    console.error('JSON Parse Error:', responseText.substring(0, 200));
                    throw new Error(`TTS ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨: ${responseText.substring(0, 100)}...`);
                }

                if (result.success === false) {
                    throw new Error(result.error || "Unknown Error from n8n");
                }

                if (result.audioUrl) {
                    // Update State
                    scene.audioUrl = result.audioUrl;
                    scene.alignmentData = result.alignment || null; // Capture timestamp data if available
                    scene.srtData = result.srt || null; // Capture SRT data

                    console.log(`[TTS Debug Scene ${sceneId}]`, result); // Debug log
                    if (!result.srt) console.warn('Missing SRT data in response');

                    // UI Update: Show Audio Player & Sync Badge
                    const hasSync = !!scene.alignmentData;
                    const srtPreview = result.srt ? result.srt.substring(0, 50).replace(/\n/g, ' ') + '...' : 'No Subtitles';

                    audioContainer.innerHTML = `
                        <audio src="${result.audioUrl}" controls class="w-full h-8" id="audio-player-${sceneId}"></audio>
                        <div class="mt-2 flex gap-2 w-full">
                            <div class="flex-1 bg-green-900/30 text-green-400 text-[10px] font-mono px-2 py-1 rounded border border-green-500/30 flex items-center justify-center gap-1">
                                <i data-lucide="check-circle-2" class="w-3 h-3"></i> Audio Ready
                            </div>
                            ${hasSync
                            ? `<div class="flex-1 bg-purple-900/30 text-purple-400 text-[10px] font-mono px-2 py-1 rounded border border-purple-500/30 flex items-center justify-center gap-1 group relative cursor-help">
                                    <i data-lucide="subtitles" class="w-3 h-3"></i> SRT Ready
                                    <div class="absolute bottom-full left-1/2 -translate-x-1/2 w-64 bg-slate-900 border border-slate-700 p-2 rounded-lg text-[10px] text-slate-300 hidden group-hover:block z-50 mb-2 shadow-xl whitespace-pre-wrap font-sans">
                                        <div class="font-bold text-white border-b border-slate-700 pb-1 mb-1">SRT Preview for Creatomate</div>
                                        ${result.srt || 'No SRT data received'}
                                    </div>
                                   </div>`
                            : `<div class="flex-1 bg-slate-800 text-slate-600 text-[10px] font-mono px-2 py-1 rounded border border-slate-700 flex items-center justify-center gap-1 opacity-50">
                                    No Sync Data
                                   </div>`
                        }
                        </div>
                    `;
                    lucide.createIcons();
                } else {
                    throw new Error("No audioUrl returned");
                }

            } catch (e) {
                console.error(e);
                alert(`TTS ìƒì„± ì‹¤íŒ¨: ${e.message}`);
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalBtnHtml;
                lucide.createIcons();
            }
        };


        // --- Event Listeners: Individual Generate ---
        document.querySelectorAll('.btn-gen-tts').forEach(btn => {
            btn.addEventListener('click', () => {
                const id = btn.getAttribute('data-id');
                generateTTS(id, btn);
            });
        });

        // --- Event Listeners: Textarea Change ---
        document.querySelectorAll('textarea[id^="tts-script-"]').forEach(ta => {
            ta.addEventListener('input', (e) => {
                const id = e.target.id.split('-').pop();
                const charCnt = document.getElementById(`tts-char-count-${id}`);
                if (charCnt) charCnt.innerText = `${e.target.value.length}ì`;

                // Update state immediately to prevent loss
                const scene = AppState.getScenes().find(s => s.sceneId == id);
                if (scene) scene.scriptForTTS = e.target.value;
            });
        });

        // --- Batch Generation ---
        const btnGenAll = document.getElementById('btn-tts-gen-all');
        if (btnGenAll) {
            btnGenAll.addEventListener('click', async () => {
                const btns = Array.from(document.querySelectorAll('.btn-gen-tts'));
                if (!confirm(`ì´ ${btns.length}ê°œ ìŠ¤í¬ë¦½íŠ¸ì— ëŒ€í•´ ìŒì„±ì„ ì¼ê´„ ìƒì„±í•©ë‹ˆë‹¤.\n(í˜„ì¬ ë³´ì´ìŠ¤ ì„¤ì •ì´ ì ìš©ë©ë‹ˆë‹¤)\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;

                btnGenAll.disabled = true;
                const originalText = btnGenAll.innerHTML;

                for (let i = 0; i < btns.length; i++) {
                    const btn = btns[i];
                    const id = btn.getAttribute('data-id');

                    btnGenAll.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> ìƒì„± ì¤‘ (${i + 1}/${btns.length})`;
                    lucide.createIcons();

                    await generateTTS(id, btn);

                    // Small safety delay
                    if (i < btns.length - 1) await new Promise(r => setTimeout(r, 1000));
                }

                btnGenAll.disabled = false;
                btnGenAll.innerHTML = originalText;
                lucide.createIcons();
                alert("ì¼ê´„ ìƒì„± ì™„ë£Œ!");
            });
        }

        // --- Sequential Playback (Preview Flow) ---
        const btnPlayAll = document.getElementById('btn-tts-play-all');
        if (btnPlayAll) {
            btnPlayAll.addEventListener('click', async () => {
                const audioElements = [];
                // Collect only available audios in order
                AppState.getScenes().forEach(s => {
                    if (s.audioUrl) {
                        const el = document.getElementById(`audio-player-${s.sceneId}`);
                        if (el) audioElements.push(el);
                    }
                });

                if (audioElements.length === 0) return alert("ì¬ìƒí•  ì˜¤ë””ì˜¤ê°€ ì—†ìŠµë‹ˆë‹¤.");

                // Stop current playback if any
                audioElements.forEach(el => { el.pause(); el.currentTime = 0; });

                btnPlayAll.disabled = true;
                btnPlayAll.innerHTML = `<i data-lucide="volume-2" class="w-4 h-4 animate-pulse"></i> ì¬ìƒ ì¤‘...`;
                lucide.createIcons();

                // Recursive play function
                const playNext = (index) => {
                    if (index >= audioElements.length) {
                        btnPlayAll.disabled = false;
                        btnPlayAll.innerHTML = `<i data-lucide="play-circle" class="w-4 h-4"></i> ì „ì²´ ì´ì–´ë“£ê¸°`;
                        lucide.createIcons();
                        return;
                    }

                    const current = audioElements[index];
                    current.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    current.parentElement.classList.add('ring-2', 'ring-blue-500'); // Highlight

                    current.play().catch(e => console.log("Auto-play blocked or error", e));

                    current.onended = () => {
                        current.parentElement.classList.remove('ring-2', 'ring-blue-500');
                        playNext(index + 1);
                    };
                };

                playNext(0);
            });
        }

        lucide.createIcons();
    }
}

// 5. Video Module (Final Assembly)
class VideoModule extends Module {
    constructor() {
        super('video', 'ìµœì¢… í¸ì§‘ì‹¤', 'film', 'ì‹œê°/ì²­ê° ìì‚° í†µí•© ë° ìµœì¢… ì˜ìƒ ìƒì„±');
    }

    render() {
        const scenes = AppState.getScenes();
        if (scenes.length === 0) return this.renderEmpty('ìƒì„±ëœ ì¥ë©´ì´ ì—†ìŠµë‹ˆë‹¤.');

        const sceneRows = scenes.map(scene => this.renderSceneRow(scene)).join('');

        return `
            <div class="max-w-6xl mx-auto slide-up space-y-6">
                <!-- Action Toolbar -->
                <div class="flex justify-between items-center bg-slate-800/40 p-4 rounded-2xl border border-slate-700/50">
                    <div class="flex items-center gap-4">
                        <span class="text-sm font-bold text-slate-400">ì´ <b>${scenes.length}</b>ê°œ ì”¬</span>
                    </div>
                    <div>
                         <button id="btn-gen-final-video" class="bg-indigo-600 hover:bg-indigo-500 text-white px-6 py-2 rounded-xl text-sm font-bold shadow-lg shadow-indigo-600/20 transition flex items-center gap-2">
                            <i data-lucide="clapperboard" class="w-4 h-4"></i> ìµœì¢… ì˜ìƒ ìƒì„± (Creatomate)
                        </button>
                    </div>
                </div>

                <!-- Final Video Preview (Hidden by default) -->
                <div id="final-video-container" class="hidden bg-slate-800/60 border border-slate-700 rounded-3xl p-6 shadow-2xl">
                    <div class="flex items-center gap-3 mb-4 border-b border-slate-700 pb-4">
                        <div class="p-2 bg-green-500/20 rounded-lg text-green-400">
                            <i data-lucide="check-circle-2" class="w-5 h-5"></i>
                        </div>
                        <h3 class="text-lg font-bold text-white">ìµœì¢… ì˜ìƒ ìƒì„± ì™„ë£Œ!</h3>
                    </div>
                    <div class="aspect-video bg-black rounded-xl overflow-hidden mb-4">
                        <video id="final-video-player" controls class="w-full h-full"></video>
                    </div>
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-slate-400">
                            <span id="final-video-info"></span>
                        </div>
                        <button id="btn-download-final" class="bg-green-600 hover:bg-green-500 text-white px-6 py-2 rounded-xl text-sm font-bold transition flex items-center gap-2">
                            <i data-lucide="download" class="w-4 h-4"></i> ìµœì¢… ì˜ìƒ ë‹¤ìš´ë¡œë“œ
                        </button>
                    </div>
                </div>

                <!-- Scene List -->
                <div class="bg-slate-800/20 border border-slate-700/50 rounded-3xl overflow-hidden shadow-2xl">
                    <table class="w-full text-left">
                        <thead class="bg-slate-900/60 border-b border-slate-700">
                            <tr>
                                <th class="py-4 pl-4 text-[10px] font-black text-slate-500 uppercase tracking-widest w-16">ID</th>
                                <th class="py-4 px-4 text-[10px] font-black text-slate-500 uppercase tracking-widest w-1/3">Visual Asset</th>
                                <th class="py-4 px-4 text-[10px] font-black text-slate-500 uppercase tracking-widest w-1/3">Audio & Subtitle</th>
                                <th class="py-4 px-4 text-[10px] font-black text-slate-500 uppercase tracking-widest text-right">Settings</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${sceneRows}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    renderSceneRow(scene) {
        const hasImage = !!scene.generatedUrl;
        const hasMotion = !!scene.videoUrl;
        const hasAudio = !!scene.audioUrl;
        // SRT ë°ì´í„° ì²´í¬ ìˆ˜ì •: srtData ë˜ëŠ” srt ë‘˜ ë‹¤ í™•ì¸
        const srtContent = scene.srtData || scene.srt || null;
        const hasSrt = !!srtContent;

        // Visual Source Toggle State (Default to motion if available, else image)
        const useMotion = hasMotion;

        return `
            <tr class="border-b border-slate-700/50 hover:bg-slate-800/30 transition group" data-scene-id="${scene.sceneId}">
                <td class="py-4 pl-4 font-mono text-xs text-slate-500 align-top pt-6">#${scene.sceneId}</td>
                
                <!-- Visual Asset Column with Drag & Drop -->
                <td class="py-4 px-4 align-top">
                    <div class="flex flex-col gap-3">
                        <div class="aspect-video bg-slate-900 rounded-lg overflow-hidden border border-slate-700 relative group-hover:border-slate-600 transition drop-zone-video"
                             data-scene-id="${scene.sceneId}"
                             ondragover="event.preventDefault(); this.classList.add('border-purple-500', 'bg-purple-500/10');"
                             ondragleave="this.classList.remove('border-purple-500', 'bg-purple-500/10');"
                             ondrop="window.handleVideoAssetDrop(event, this)">
                            ${useMotion && hasMotion
                ? `<video src="${scene.videoUrl}" controls class="w-full h-full object-cover"></video>`
                : (hasImage ? `<img src="${scene.generatedUrl}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center text-xs text-slate-600">No Asset<br><span class="text-[10px] opacity-60">Drag to Replace</span></div>`
                )}
                            <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition flex items-center justify-center gap-2">
                                ${scene.generatedUrl ? `
                                    <button onclick="openLightbox('${scene.generatedUrl}')" class="p-2 bg-white/20 hover:bg-white/40 rounded-full text-white backdrop-blur-sm transition" title="í¬ê²Œ ë³´ê¸°">
                                        <i data-lucide="maximize-2" class="w-4 h-4"></i>
                                    </button>
                                ` : ''}
                                <label class="p-2 bg-white/20 hover:bg-white/40 rounded-full text-white backdrop-blur-sm transition cursor-pointer" title="íŒŒì¼ ì„ íƒ">
                                    <i data-lucide="upload" class="w-4 h-4"></i>
                                    <input type="file" accept="image/*,video/*" class="hidden" onchange="window.handleVideoFileSelect(event, ${scene.sceneId})">
                                </label>
                            </div>
                            <!-- Drag Hint -->
                            <div class="absolute bottom-1 right-1 text-[7px] text-slate-500 bg-black/40 px-1 rounded opacity-0 group-hover:opacity-100 transition pointer-events-none">
                                ğŸ“ Drop to replace
                            </div>
                        </div>
                    </div>
                </td>

                <!-- Audio & Subtitle Column -->
                <td class="py-4 px-4 align-top">
                    <div class="space-y-2">
                        <div class="p-3 bg-slate-900/50 rounded-xl border border-slate-700">
                             <div class="flex items-center justify-between mb-2">
                                <span class="text-xs font-bold text-slate-400">Audio Track</span>
                                ${hasAudio
                ? `<span class="text-[10px] text-green-400 font-mono bg-green-900/30 px-1.5 py-0.5 rounded border border-green-500/30">Ready</span>`
                : `<span class="text-[10px] text-red-400 font-mono bg-red-900/30 px-1.5 py-0.5 rounded border border-red-500/30">Missing</span>`
            }
                             </div>
                             ${hasAudio ? `<audio src="${scene.audioUrl}" controls class="w-full h-6 rounded"></audio>` : ''}
                        </div>

                        <div class="p-3 bg-slate-900/50 rounded-xl border border-slate-700">
                             <div class="flex items-center justify-between mb-2">
                                <span class="text-xs font-bold text-slate-400">Subtitle (SRT)</span>
                                ${hasSrt
                ? `<span class="text-[10px] text-purple-400 font-mono bg-purple-900/30 px-1.5 py-0.5 rounded border border-purple-500/30">Sync Data</span>`
                : `<span class="text-[10px] text-slate-500 font-mono">No Data</span>`
            }
                             </div>
                             <div class="text-[10px] text-slate-400 font-mono h-12 overflow-y-auto bg-black/20 p-2 rounded">
                                ${hasSrt ? srtContent.replace(/\n/g, '<br>') : '...'}
                             </div>
                        </div>
                    </div>
                </td>

                <!-- Settings -->
                <td class="py-4 px-4 align-top text-right">
                    <div class="flex flex-col gap-2 items-end">
                        <label class="flex items-center gap-2 text-xs text-slate-400 cursor-pointer">
                            <input type="checkbox" checked class="rounded bg-slate-700 border-slate-600 text-blue-600 focus:ring-0">
                            <span>Include in Final Video</span>
                        </label>
                    </div>
                </td>
            </tr>
        `;
    }

    onMount() {
        super.onMount();

        // Handle "Generate Final Video" button
        const btnGen = document.getElementById('btn-gen-final-video');
        if (btnGen) {
            btnGen.addEventListener('click', () => this.generateFinalVideo(btnGen));
        }
    }

    async generateFinalVideo(btn) {
        if (!confirm('ëª¨ë“  ì”¬ì„ í•˜ë‚˜ë¡œ í•©ì³ ìµœì¢… ì˜ìƒì„ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

        const scenes = AppState.getScenes();

        // Helper: Extract duration from SRT content (last timestamp)
        const getDurationFromSRT = (srtContent) => {
            if (!srtContent) return 5; // Default 5s if no SRT

            const timeRegex = /(\d{2}):(\d{2}):(\d{2}),(\d{3})/g;
            const matches = [...srtContent.matchAll(timeRegex)];

            if (matches.length === 0) return 5;

            // Get last timestamp (even index = start, odd = end)
            const lastMatch = matches[matches.length - 1];
            const [_, hours, minutes, seconds, milliseconds] = lastMatch;

            const totalSeconds =
                parseInt(hours) * 3600 +
                parseInt(minutes) * 60 +
                parseInt(seconds) +
                parseInt(milliseconds) / 1000;

            return Math.ceil(totalSeconds); // Round up to ensure full audio
        };

        const timeline = scenes.map(s => ({
            sceneId: s.sceneId,
            visualUrl: s.videoUrl || s.generatedUrl, // Prefer video, fallback to image
            audioUrl: s.audioUrl,
            srtContent: s.srtData,
            duration: getDurationFromSRT(s.srtData) // Calculate from SRT timestamps
        })).filter(item => {
            if (!item.visualUrl || !item.audioUrl) return false;

            // Check for large Base64 (approx > 2MB) which might fail in Creatomate download
            if (item.visualUrl.startsWith('data:image') && item.visualUrl.length > 2000000) {
                console.warn(`Scene ${item.sceneId}: Base64 image might be too large for direct download.`);
                // We still allow it but maybe we should warn? 
                // Actually, let's allow it but rely on n8n to handle it if possible.
                // But better yet, if we have a cloud URL (which we don't for generic DALL-E unless uploaded), 
                // we face this issue. 
                // Let's just proceed.
            }
            return true;
        });

        if (timeline.length === 0) return alert('ìƒì„± ê°€ëŠ¥í•œ ì”¬ì´ ì—†ìŠµë‹ˆë‹¤. (ì´ë¯¸ì§€/ë™ì˜ìƒ + ì˜¤ë””ì˜¤ í•„ìˆ˜)');

        console.log("âœ… Sending to n8n - Video Timeline:", timeline);

        // Show loading state
        const totalDuration = timeline.reduce((sum, item) => sum + item.duration, 0);
        btn.disabled = true;
        const originalText = btn.innerHTML;
        btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> ìƒì„± ì¤‘... (ì•½ ${Math.ceil(totalDuration / 60)}ë¶„ ì˜ˆìƒ)`;
        lucide.createIcons();

        try {
            // Call n8n video workflow
            const response = await fetch(CONFIG.endpoints.video, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ timeline })
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Server Error (${response.status}): ${errorText}`);
            }

            const result = await response.json();
            console.log("âœ… Creatomate Response:", result);

            // Expected response from Creatomate: { url: 'video_url', id: 'render_id', status: 'succeeded' }
            if (result.url || result.video_url) {
                const videoUrl = result.url || result.video_url;

                // Show final video container
                const container = document.getElementById('final-video-container');
                const player = document.getElementById('final-video-player');
                const info = document.getElementById('final-video-info');
                const downloadBtn = document.getElementById('btn-download-final');

                if (container && player && info && downloadBtn) {
                    player.src = videoUrl;
                    info.textContent = `ì´ ${timeline.length}ê°œ ì”¬ | ì¬ìƒ ì‹œê°„: ${totalDuration}ì´ˆ`;
                    container.classList.remove('hidden');

                    // Download handler
                    downloadBtn.onclick = () => {
                        const link = document.createElement('a');
                        link.href = videoUrl;
                        link.download = `final_video_${Date.now()}.mp4`;
                        link.click();
                    };

                    lucide.createIcons();

                    // Scroll to video
                    container.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }

                alert(`âœ… ìµœì¢… ì˜ìƒ ìƒì„± ì™„ë£Œ!\n\nì•„ë˜ì—ì„œ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
            } else {
                throw new Error('No video URL in response. Check n8n workflow and Creatomate API key.');
            }

        } catch (e) {
            console.error('âŒ Video Generation Error:', e);
            alert(`ì˜ìƒ ìƒì„± ì‹¤íŒ¨:\n${e.message}\n\nn8n ì›Œí¬í”Œë¡œìš°ì™€ Creatomate API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.`);
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalText;
            lucide.createIcons();
        }
    }
}

// --- ğŸ® APP CONTROLLER ---
class App {
    constructor() {
        this.modules = [
            // new Module('home', 'ëŒ€ì‹œë³´ë“œ', 'layout-dashboard', 'ì „ì²´ ì‘ì—… íë¦„'), // Replaced by standard modules
            new TrendModule(),
            new YoutubeModule(),
            new ScriptModule(),
            new ImageModule(),
            new MotionModule(),
            new TTSModule(),
            new VideoModule()
        ];
        this.currentModuleId = 'script'; // Default start
        this.init();
    }

    init() {
        this.renderNav();
        this.route(this.currentModuleId);
    }

    renderNav() {
        const nav = document.getElementById('main-nav');
        nav.innerHTML = this.modules.map(mod => {
            const isActive = this.currentModuleId === mod.id;
            const baseClass = "flex items-center gap-4 px-6 py-4 rounded-xl transition-all duration-300 relative overflow-hidden group w-full text-left";
            const activeClass = "bg-blue-600/20 text-blue-400 border border-blue-500/30 shadow-[0_0_20px_rgba(59,130,246,0.3)]";
            const inactiveClass = "text-slate-400 hover:bg-white/10 hover:text-white";

            return `
                <button onclick="app.route('${mod.id}')" class="${baseClass} ${isActive ? activeClass : inactiveClass}">
                    ${isActive ? `<div class="absolute left-0 top-0 w-1 h-full bg-blue-500 shadow-[0_0_10px_#3b82f6]"></div>` : ''}
                    <i data-lucide="${mod.icon}" class="w-5 h-5 group-hover:scale-110 transition-transform"></i>
                    <span class="font-bold text-sm tracking-wide">${mod.name}</span>
                </button>
                ${mod.id === 'home' || mod.id === 'youtube' ? '<div class="h-px bg-slate-800 m-2 mx-4"></div>' : ''}
            `;
        }).join('');
        lucide.createIcons();
    }

    route(moduleId) {
        this.currentModuleId = moduleId;
        const module = this.modules.find(m => m.id === moduleId);

        // Update Nav UI
        this.renderNav();

        // Update Header
        document.getElementById('page-title').innerText = module.name;
        document.getElementById('page-desc').innerText = module.desc || "";

        // Render Content
        const contentArea = document.getElementById('app-content');
        contentArea.innerHTML = module.render();

        // Execute Logic
        module.onMount();

        lucide.createIcons();
    }
}

// Start Application
const app = new App();

// --- ğŸ–¼ï¸ GLOBAL LIGHTBOX LOGIC ---
const lightboxOverlay = document.getElementById('lightbox-overlay');
const lightboxContent = document.getElementById('lightbox-content');
const lightboxClose = document.getElementById('lightbox-close');

window.openLightbox = (content) => {
    // Check if content is URL (image) or HTML
    if (content.match(/\.(jpeg|jpg|gif|png|webp)$/) || content.startsWith('data:image')) {
        lightboxContent.innerHTML = `<img src="${content}" class="max-w-[90vw] max-h-[90vh] rounded-lg shadow-2xl object-contain">`;
    } else if (content.match(/\.(mp4|webm)$/)) {
        lightboxContent.innerHTML = `<video src="${content}" controls autoplay class="max-w-[90vw] max-h-[90vh] rounded-lg shadow-2xl"></video>`;
    } else {
        lightboxContent.innerHTML = content;
    }

    lightboxOverlay.classList.remove('hidden');
    document.body.style.overflow = 'hidden'; // Prevent scrolling
};

const closeLightbox = () => {
    lightboxOverlay.classList.add('hidden');
    lightboxContent.innerHTML = '';
    document.body.style.overflow = '';
};

if (lightboxClose) lightboxClose.addEventListener('click', closeLightbox);
if (lightboxOverlay) {
    lightboxOverlay.addEventListener('click', (e) => {
        if (e.target === lightboxOverlay) closeLightbox();
    });
}
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !lightboxOverlay.classList.contains('hidden')) closeLightbox();
});

// --- ğŸ“ GLOBAL DRAG-AND-DROP ASSET REPLACEMENT ---
window.handleAssetDrop = (event, dropZone) => {
    event.preventDefault();
    dropZone.classList.remove('border-blue-500', 'bg-blue-500/10', 'border-purple-500', 'bg-purple-500/10');

    const sceneId = dropZone.getAttribute('data-scene-id');
    const dropType = dropZone.getAttribute('data-drop-type'); // 'image' or 'video'
    const files = event.dataTransfer.files;

    if (files.length === 0) return;

    const file = files[0];
    const fileType = file.type;

    // Validate file type
    if (dropType === 'image' && !fileType.startsWith('image/')) {
        return alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤. (JPG, PNG, WebP ë“±)');
    }
    if (dropType === 'video' && !fileType.startsWith('video/')) {
        return alert('ë™ì˜ìƒ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤. (MP4, WebM ë“±)');
    }

    // Read file as Base64
    const reader = new FileReader();
    reader.onload = (e) => {
        const base64Data = e.target.result;
        const scene = AppState.getScenes().find(s => s.sceneId == sceneId);

        if (!scene) return console.error('Scene not found:', sceneId);

        // Update state
        if (dropType === 'image') {
            scene.generatedUrl = base64Data;
            // Update UI
            const img = document.getElementById(`img-${sceneId}`);
            const placeholder = dropZone.querySelector('.image-placeholder');
            if (img && placeholder) {
                img.src = base64Data;
                img.classList.remove('hidden');
                placeholder.classList.add('hidden');
            }
            console.log(`âœ… Scene ${sceneId}: Image replaced via drag-drop`);
        } else if (dropType === 'video') {
            scene.videoUrl = base64Data;
            // Update UI
            const videoContainer = dropZone;
            videoContainer.innerHTML = `
                <video src="${base64Data}" class="w-full h-full object-cover cursor-pointer" onclick="window.openLightbox(this.src)" title="í´ë¦­í•˜ì—¬ í¬ê²Œ ë³´ê¸°"></video>
                <div class="absolute bottom-1 right-1 text-[7px] text-slate-500 bg-black/40 px-1 rounded opacity-0 group-hover/video:opacity-100 transition pointer-events-none">
                    ğŸ“ Drop to replace
                </div>
            `;
            // Re-add drop handlers
            videoContainer.setAttribute('ondragover', "event.preventDefault(); this.classList.add('border-purple-500', 'bg-purple-500/10');");
            videoContainer.setAttribute('ondragleave', "this.classList.remove('border-purple-500', 'bg-purple-500/10');");
            videoContainer.setAttribute('ondrop', 'window.handleAssetDrop(event, this)');
            console.log(`âœ… Scene ${sceneId}: Video replaced via drag-drop`);
        }

        // Show success feedback
        const successMsg = document.createElement('div');
        successMsg.className = 'fixed bottom-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-bounce';
        successMsg.innerHTML = `<i data-lucide="check-circle" class="w-4 h-4 inline"></i> Scene ${sceneId} ${dropType === 'image' ? 'ì´ë¯¸ì§€' : 'ë™ì˜ìƒ'} êµì²´ ì™„ë£Œ!`;
        document.body.appendChild(successMsg);
        lucide.createIcons();
        setTimeout(() => successMsg.remove(), 3000);
    };

    reader.onerror = () => {
        alert('íŒŒì¼ ì½ê¸° ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    };

    reader.readAsDataURL(file);
};
